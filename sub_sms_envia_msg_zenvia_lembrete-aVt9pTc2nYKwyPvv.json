{"createdAt":"2026-01-14T12:58:48.028Z","updatedAt":"2026-02-05T17:36:23.961Z","id":"aVt9pTc2nYKwyPvv","name":"SUB_SMS_ENVIA_MSG_ZENVIA_LEMBRETE","active":false,"isArchived":false,"nodes":[{"parameters":{"method":"POST","url":"https://api.zenvia.com/v2/channels/sms/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-API-TOKEN","value":"FfLUl-xKIxTAOEOEkLp5fgt24-c8zk8QtSJv"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"from\": \"lembranca\",\n  \"to\": \"{{ $('dadosLoop').item.json.celular_associado }}\",\n  \"contents\": [\n    {\n      \"type\": \"text\",\n      \"text\": \"{{$('dadosMensagem').item.json.mensagem }}\"\n    }\n  ]\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1184,1008],"id":"9d1ab679-99c8-46aa-b8f7-a4bcaf01856f","name":"smsZenviaPVCE","alwaysOutputData":true,"executeOnce":true,"onError":"continueRegularOutput"},{"parameters":{"assignments":{"assignments":[{"id":"bd448a7b-74b4-4d15-b1b2-55d1ffae25bb","name":"nome_associado","value":"={{\n(() => {\n  const nome = ($json.nome_associado || '')\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .trim()\n    .toLowerCase()\n    .split(/\\s+/);\n\n  if (!nome.length) return '';\n\n  const cap = s => s.charAt(0).toUpperCase() + s.slice(1);\n\n  return nome.length > 1\n    ? `${cap(nome[0])} ${cap(nome[nome.length - 1])}`\n    : cap(nome[0]);\n})()\n}}","type":"string"},{"id":"a3aeb4f0-662c-42aa-855c-1621be3f96d3","name":"celular_associado","value":"={{ $json.celular_match ?? 553192240123 }}","type":"string"},{"id":"4f75d997-9b52-46a8-9fd5-089769dec633","name":"placa","value":"={{ $json.placa }}","type":"string"},{"id":"8e23ffe7-9157-4f0c-9ed8-fd7639137d96","name":"nosso_numero","value":"={{ $json.nosso_numero }}","type":"string"},{"id":"22c21721-a0a6-4322-b899-d134d161f844","name":"data_vencimento","value":"={{ $json.data_vencimento_toDateTime }}","type":"string"},{"id":"3c41cc18-a96a-493d-9bad-4aae17537c17","name":"tipo_boleto","value":"={{ $json.tipo_boleto }}","type":"string"},{"id":"bda41740-30c9-45bf-b2fc-6a9537ca418d","name":"valor_boleto","value":"={{ $json.valor_boleto }}","type":"string"},{"id":"6c5de1fb-6dc9-4a73-955c-d751e5673887","name":"link_boleto","value":"={{ $json.link_boleto }}","type":"string"},{"id":"6c2e85d4-335c-4ade-b75c-2d5d05c00448","name":"mes_referente","value":"={{ $json.mes_referente }}","type":"string"},{"id":"c335076f-6258-4e78-b380-074460bcc495","name":"situacao_veiculo","value":"={{ $json.situacao_veiculo }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[736,1104],"id":"1b7ce18d-14b7-4918-bd02-819e9dcfdce1","name":"dadosLoop"},{"parameters":{"assignments":{"assignments":[{"id":"625e8b1a-9517-4ac2-873e-d11c7625d2a6","name":"mensagem","value":"=Ola {{ $json.nome_associado }}, somos da Top Brasil.\\nSeu boleto vence hoje {{ $('dadosLoop').item.json.data_vencimento.toDateTime().format('dd/MM/yyyy') }}!\\nPDF do Boleto: {{ $('dadosLoop').item.json.link_boleto }}\\nDuvidas, entre em contato atraves da nossa central: 31 982073313","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[960,1008],"id":"a45a7e6c-78c9-4b65-90df-35b5c606238c","name":"dadosMensagem"},{"parameters":{"operation":"executeQuery","query":"UPDATE topBIBoletos\nSET msg_sms_znv_diavencimento = true, dth_envio_sms_znv_diavencimento = CURRENT_TIMESTAMP, msg_texto_sms_znv_diavencimento = $2 \nWHERE nosso_numero = $1;","options":{"queryReplacement":"={{\n[\n  $('Start').item.json.nosso_numero,\n  $('smsZenviaPVCE').item.json.id + ' - ' +  $json.contents[0].text\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1408,1008],"id":"7a43aa2a-bfbb-4570-a56c-e975a4c8a063","name":"Execute a SQL query","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}},"onError":"continueRegularOutput"},{"parameters":{"workflowInputs":{"values":[{"name":"nome_associado","type":"any"},{"name":"celular_match","type":"any"},{"name":"placa","type":"any"},{"name":"nosso_numero","type":"any"},{"name":"data_vencimento_toDateTime","type":"any"},{"name":"tipo_boleto","type":"any"},{"name":"valor_boleto","type":"any"},{"name":"link_boleto","type":"any"},{"name":"mes_referente","type":"any"},{"name":"situacao_veiculo","type":"any"}]}},"id":"171f9d8c-e1af-4053-8e3c-fa70787dab2e","typeVersion":1.1,"name":"Start","type":"n8n-nodes-base.executeWorkflowTrigger","position":[512,1104]},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1184,1200],"id":"6c282e7c-fc29-445a-8410-5c6ee499754e","name":"Wait2","webhookId":"b79945cb-124f-48d6-9aee-d0c185276ac0"},{"parameters":{"jsCode":"for (const item of $input.all()) {\n  const json = item.json;\n\n  // 1. Data formatada\n  let dataFormatada = '-';\n  if (json.data_vencimento) {\n    try {\n      dataFormatada = json.data_vencimento\n        .split('T')[0]\n        .split('-')\n        .reverse()\n        .join('/');\n    } catch {}\n  }\n  json.data_vencimento_formatada = dataFormatada;\n\n  // 2. Valor do boleto (auto-detecção)\n  let valorFormatado = '-';\n\n  if (json.valor_boleto !== null && json.valor_boleto !== undefined) {\n    try {\n      let valorStr = json.valor_boleto.toString().trim();\n      let valorNumerico;\n\n      // Se contém ponto ou vírgula → já está em reais\n      if (valorStr.includes('.') || valorStr.includes(',')) {\n        valorNumerico = Number(valorStr.replace(',', '.'));\n      } else {\n        // Caso contrário → centavos\n        valorNumerico = Number(valorStr) / 100;\n      }\n\n      if (!isNaN(valorNumerico)) {\n        valorFormatado = valorNumerico.toLocaleString('pt-BR', {\n          style: 'currency',\n          currency: 'BRL',\n        });\n      }\n    } catch {}\n  }\n\n  json.valor_boleto_formatado = valorFormatado;\n\n  // 3. Campos simples\n  json.nome_associado_clean = json.nome_associado || '-';\n  json.placa_clean = json.placa || '-';\n  json.link_boleto_clean = json.link_boleto || '-';\n}\n\nreturn $input.all();\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[960,1200],"id":"65ae7a47-4be1-4819-830e-5b736508e577","name":"Code in JavaScript"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v23.0/864975313369366/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAATUk0ZAXAHcBP2kf4RiafS5WQycrzlYKLhxBhuiMBKEydsZBLPZBWb1CTEcd78lpVrwWmZAvstmjVn9XRZBRldPDC8EDdPceYHDlZCd3qC5KDDCOX4EIJ2eKkEyR3vM9znAAUBgDbhRZAsgxj2XmdLp6fZAgBANi7faZAU7YZB2HhdoTqUT6mHXnEZBwX742bHiVQppwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $('Start').item.json.celular_match.match(/\\d+/g ).join('')}}\", \n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"mkt_boleto_previa_start_app\",\n    \"language\": { \"code\": \"pt_BR\" },\n    \"components\": [\n      {\n        \"type\": \"body\",\n        \"parameters\": [\n          { \"type\": \"text\", \"text\": \"{{ $json.nome_associado_clean }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.placa_clean }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.data_vencimento_formatada }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.valor_boleto_formatado }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.link_boleto_clean }}\" }\n        ]\n      }\n    ]\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1408,1200],"id":"e4569b17-9685-4759-a6dc-2f9fb504724d","name":"mkt_boleto_previa_start_app","onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"UPDATE topBIBoletos\nSET msgBoletoEnviada = true, msg_zap_ezchat_lembrete = true, dth_envio_zap_ezchat_lembrete = CURRENT_TIMESTAMP, msg_texto_zap_ezchat_lembrete = 'mkt_boleto_previa_start_app' \nWHERE nosso_numero = '{{$('Start').item.json.nosso_numero}}';","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[1632,1200],"id":"40b2e2c3-df84-4b9c-90a8-a35bcd08b04c","name":"atualizaBoleto","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}}],"connections":{"dadosLoop":{"main":[[{"node":"dadosMensagem","type":"main","index":0},{"node":"Code in JavaScript","type":"main","index":0}]]},"dadosMensagem":{"main":[[{"node":"smsZenviaPVCE","type":"main","index":0}]]},"smsZenviaPVCE":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Start":{"main":[[{"node":"dadosLoop","type":"main","index":0}]]},"Wait2":{"main":[[{"node":"mkt_boleto_previa_start_app","type":"main","index":0}]]},"Code in JavaScript":{"main":[[{"node":"Wait2","type":"main","index":0}]]},"mkt_boleto_previa_start_app":{"main":[[{"node":"atualizaBoleto","type":"main","index":0}]]},"atualizaBoleto":{"main":[[]]}},"settings":{"executionOrder":"v1","saveDataSuccessExecution":"all","saveExecutionProgress":false,"saveManualExecutions":false,"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"TfwD6eX8vHLcjYJt","timeSavedPerExecution":1,"saveDataErrorExecution":"all"},"staticData":null,"meta":null,"pinData":{"Start":[{"json":{"nome_associado":"GC LOCACAO E COMERCIALIZACAO DE VEICULOS","celular_match":"5516981281674","placa":"","nosso_numero":"40199816","data_vencimento_toDateTime":"2026-01-14\n","tipo_boleto":"FECHAMENTO","valor_boleto":"11840.16","link_boleto":"https://short.hinova.com.br/v2/wbxkSzKQ.pdf","mes_referente":"12/2025","situacao_veiculo":"ATIVO"}}],"dadosLoop":[{"json":{"nome_associado":"Valdeir Goncalves","celular_associado":null,"placa":"PBK6G04","nosso_numero":"40168983","data_vencimento":"2026-01-15","tipo_boleto":"FECHAMENTO","valor_boleto":"247.17","link_boleto":"https://short.hinova.com.br/v2/QT9h5S0F.pdf","mes_referente":"12/2025","situacao_veiculo":"ATIVO"}}]},"versionId":"6552096c-9585-48d9-a16f-063df5e2e3d4","triggerCount":0,"shared":[{"createdAt":"2026-01-14T12:58:48.028Z","updatedAt":"2026-01-14T12:58:48.028Z","role":"workflow:owner","workflowId":"aVt9pTc2nYKwyPvv","projectId":"Q1ZOyZgW3upjWPqV"}],"tags":[]}