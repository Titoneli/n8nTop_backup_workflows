{"createdAt":"2025-09-22T13:45:45.429Z","updatedAt":"2025-12-04T19:21:56.615Z","id":"RD03yANEp72b5TPY","name":"TMR_MSG_BOLETOS_ASSOCIADOS_TOP","active":true,"isArchived":false,"nodes":[{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-64,992],"id":"77d4549a-55ab-4796-8d0a-b810bdb3b8c7","name":"Aggregate1"},{"parameters":{"rule":{"interval":[{"triggerAtHour":7}]}},"id":"8a94e135-6329-449d-b080-86b6f4d2d54f","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[-704,1184],"executeOnce":true},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-288,1184],"id":"0648b82b-da32-48bd-81cc-5912540abb8e","name":"loopBoletosBI"},{"parameters":{"operation":"executeQuery","query":"SELECT *\nFROM topBIBoletos\n  WHERE msgBoletoEnviada = false\n    AND situacao_boleto = 'ABERTO'\n    AND tipo_boleto in ('FECHAMENTO', 'MIGRAÇÃO DE SISTEMA')\n    AND link_boleto is not null\n    AND data_vencimento between '2025-12-05' and '2025-12-06'\n    --AND codigo_regional = '248'\nORDER BY data_vencimento_original\nLIMIT 1000;\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-496,1184],"id":"42c188d4-c5aa-4bac-b2ef-668498a5c8ff","name":"buscaBoletos","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[144,1200],"id":"d6b6e8dd-a4a3-414e-854d-86d94b30b668","name":"Wait2","webhookId":"b79945cb-124f-48d6-9aee-d0c185276ac0"},{"parameters":{"operation":"send","phoneNumberId":"864975313369366","recipientPhoneNumber":"=+5531992240123","textBody":"=Envio da mensagem do boleto + app finalizado","additionalFields":{}},"type":"n8n-nodes-base.whatsApp","typeVersion":1,"position":[144,992],"id":"9c3bf37f-fd9e-45bb-aa7f-cfa33421b8b3","name":"Send message","webhookId":"35eedcdd-5cef-4732-9baf-41b9d408b432","credentials":{"whatsAppApi":{"id":"uhkZVEvkMfFDnJdn","name":"BM TOP WABA 1659637782089115 3195929809"}}},{"parameters":{"jsCode":"// Exemplo de código para o nó Function:\nfor (const item of $input.all()) {\n  const json = item.json;\n\n  // 1. Tratamento da Data (Mais Seguro)\n  let dataFormatada = '-';\n  if (json.data_vencimento) {\n    // Verifica se a data é válida antes de tentar split\n    try {\n      dataFormatada = json.data_vencimento.split('T')[0].split('-').reverse().join('/');\n    } catch (e) {\n      // Deixa como '-' se falhar\n    }\n  }\n  json.data_vencimento_formatada = dataFormatada;\n\n  // 2. Tratamento do Valor (Garante String e R$)\n  let valorFormatado = '-';\n  if (json.valor_boleto) {\n    valorFormatado = 'R$' + json.valor_boleto.toString();\n  }\n  json.valor_boleto_formatado = valorFormatado;\n\n  // 3. Tratamento dos Campos Simples\n  json.nome_associado_clean = json.nome_associado || '-';\n  json.placa_clean = json.placa || '-';\n  json.link_boleto_clean = json.link_boleto || '-';\n}\n\nreturn $input.all();"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,1200],"id":"7fdac6d0-363a-4e88-a0ab-c6554d626921","name":"Code in JavaScript"},{"parameters":{"operation":"executeQuery","query":"UPDATE topBIBoletos\nSET msgBoletoEnviada = true\nWHERE nosso_numero = '{{ $('loopBoletosBI').item.json.nosso_numero }}'\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[576,1200],"id":"a9d0b623-5d44-4aa8-965a-c2f40b9ffb5a","name":"buscaBoletos1","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v23.0/864975313369366/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAATUk0ZAXAHcBP2kf4RiafS5WQycrzlYKLhxBhuiMBKEydsZBLPZBWb1CTEcd78lpVrwWmZAvstmjVn9XRZBRldPDC8EDdPceYHDlZCd3qC5KDDCOX4EIJ2eKkEyR3vM9znAAUBgDbhRZAsgxj2XmdLp6fZAgBANi7faZAU7YZB2HhdoTqUT6mHXnEZBwX742bHiVQppwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{'55'+ $('loopBoletosBI').item.json.celular.match(/\\d+/g ).join('')}}\", \n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"mkt_boleto_previa_start_app\",\n    \"language\": { \"code\": \"pt_BR\" },\n    \"components\": [\n      {\n        \"type\": \"body\",\n        \"parameters\": [\n          { \"type\": \"text\", \"text\": \"{{ $json.nome_associado_clean }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.placa_clean }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.data_vencimento_formatada }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.valor_boleto_formatado }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.link_boleto_clean }}\" }\n        ]\n      }\n    ]\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[368,1200],"id":"c9b4ef75-9915-4d7d-8c16-1e186b558f1f","name":"mkt_boleto_previa_start_app","onError":"continueRegularOutput"},{"parameters":{"path":"454df8ec-252b-4878-a83c-2bbc087c353a","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-704,1008],"id":"1520fd62-0cd8-418f-b7ad-2a944aeea5ef","name":"Webhook","webhookId":"454df8ec-252b-4878-a83c-2bbc087c353a"}],"connections":{"Schedule Trigger":{"main":[[{"node":"buscaBoletos","type":"main","index":0}]]},"loopBoletosBI":{"main":[[{"node":"Aggregate1","type":"main","index":0}],[{"node":"Code in JavaScript","type":"main","index":0}]]},"buscaBoletos":{"main":[[{"node":"loopBoletosBI","type":"main","index":0}]]},"Wait2":{"main":[[{"node":"mkt_boleto_previa_start_app","type":"main","index":0}]]},"Send message":{"main":[[]]},"Code in JavaScript":{"main":[[{"node":"Wait2","type":"main","index":0}]]},"Aggregate1":{"main":[[{"node":"Send message","type":"main","index":0}]]},"buscaBoletos1":{"main":[[{"node":"loopBoletosBI","type":"main","index":0}]]},"mkt_boleto_previa_start_app":{"main":[[{"node":"buscaBoletos1","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"buscaBoletos","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataErrorExecution":"all","saveDataSuccessExecution":"all","saveExecutionProgress":true,"saveManualExecutions":true,"callerPolicy":"workflowsFromSameOwner"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Schedule Trigger1":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"441b161b-c8ca-4d72-8d4b-8c7fb7fcc0dc","triggerCount":2,"shared":[{"createdAt":"2025-09-22T13:45:45.429Z","updatedAt":"2025-09-22T13:45:45.429Z","role":"workflow:owner","workflowId":"RD03yANEp72b5TPY","projectId":"Q1ZOyZgW3upjWPqV"}],"tags":[{"createdAt":"2025-07-12T12:17:26.642Z","updatedAt":"2025-07-12T12:17:26.642Z","id":"TN2r2A362fmMHecy","name":"WHATSAPP"},{"createdAt":"2025-07-12T12:17:26.644Z","updatedAt":"2025-07-12T12:17:26.644Z","id":"pIMmsZ0yhW61pdRj","name":"MENSAGENS"}]}