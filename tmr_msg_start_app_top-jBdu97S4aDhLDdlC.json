{"createdAt":"2025-11-18T16:56:07.433Z","updatedAt":"2025-12-02T14:22:32.552Z","id":"jBdu97S4aDhLDdlC","name":"TMR_MSG_START_APP_TOP","active":false,"isArchived":false,"nodes":[{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-64,992],"id":"06b8eab5-832b-4a6f-a880-10fff720687e","name":"Aggregate1"},{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"0 8-18 * * 1-5"}]}},"id":"4d96e60d-1833-45a4-80ae-abce1eb30c38","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[-704,1184],"executeOnce":true},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-288,1184],"id":"b59d71d0-4d27-4ec5-b745-bf02b7ac5da8","name":"loopBoletosBI"},{"parameters":{"operation":"executeQuery","query":"SELECT *\nFROM topBIBoletos\n  WHERE msg_aplicativo = false\n    AND data_vencimento >= CURRENT_DATE\nLIMIT 1000;\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-496,1184],"id":"81dd66d3-d0e8-43e9-aa87-2babbfa52a15","name":"buscaBoletos","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[144,1200],"id":"66c6736e-0438-41c4-899a-fa4a264a50d1","name":"Wait2","webhookId":"e281d38f-1132-49fd-84f3-c6b1b93d0eba"},{"parameters":{"operation":"send","phoneNumberId":"864975313369366","recipientPhoneNumber":"=+5531992240123","textBody":"=Envio da mensagem do boleto + app finalizado","additionalFields":{}},"type":"n8n-nodes-base.whatsApp","typeVersion":1,"position":[144,992],"id":"3af7f3de-8101-4061-8000-2de4f2e16d0b","name":"Send message","webhookId":"5edccbed-b988-44f0-8ab5-695bbfc1218c","credentials":{"whatsAppApi":{"id":"uhkZVEvkMfFDnJdn","name":"BM TOP WABA 1659637782089115 3195929809"}}},{"parameters":{"jsCode":"// Exemplo de código para o nó Function:\nfor (const item of $input.all()) {\n  const json = item.json;\n\n  // 1. Tratamento da Data (Mais Seguro)\n  let dataFormatada = '-';\n  if (json.data_vencimento) {\n    // Verifica se a data é válida antes de tentar split\n    try {\n      dataFormatada = json.data_vencimento.split('T')[0].split('-').reverse().join('/');\n    } catch (e) {\n      // Deixa como '-' se falhar\n    }\n  }\n  json.data_vencimento_formatada = dataFormatada;\n\n  // 2. Tratamento do Valor (Garante String e R$)\n  let valorFormatado = '-';\n  if (json.valor_boleto) {\n    valorFormatado = 'R$' + json.valor_boleto.toString();\n  }\n  json.valor_boleto_formatado = valorFormatado;\n\n  // 3. Tratamento dos Campos Simples\n  json.nome_associado_clean = json.nome_associado || '-';\n  json.placa_clean = json.placa || '-';\n  json.link_boleto_clean = json.link_boleto || '-';\n}\n\nreturn $input.all();"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,1200],"id":"d1929226-30f9-4225-8276-5fc7b5d32d32","name":"Code in JavaScript"},{"parameters":{"operation":"executeQuery","query":"UPDATE topBIBoletos\nSET msg_aplicativo = true\nWHERE nosso_numero = '{{ $('loopBoletosBI').item.json.nosso_numero }}'\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[576,1200],"id":"1caaa7f2-5d3b-499e-b99d-d3517c539f3f","name":"buscaBoletos1","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v23.0/864975313369366/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer EAATUk0ZAXAHcBP2kf4RiafS5WQycrzlYKLhxBhuiMBKEydsZBLPZBWb1CTEcd78lpVrwWmZAvstmjVn9XRZBRldPDC8EDdPceYHDlZCd3qC5KDDCOX4EIJ2eKkEyR3vM9znAAUBgDbhRZAsgxj2XmdLp6fZAgBANi7faZAU7YZB2HhdoTqUT6mHXnEZBwX742bHiVQppwZDZD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{'55' + $('loopBoletosBI').item.json.celular.match(/\\d+/g ).join('')}}\", \n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"mkt_start_app\",\n    \"language\": { \"code\": \"pt_BR\" },\n    \"components\": [\n      {\n        \"type\": \"header\",\n        \"parameters\": [\n          {\n            \"type\": \"image\",\n            \"image\": {\n              \"link\": \"https://topbrasilpv-automacao.obs.la-south-2.myhuaweicloud.com/lancamento_app_seu_boleto_vence_em_x.jpg\"\n            }\n          }\n        ]\n      },      \n      {\n        \"type\": \"body\",\n        \"parameters\": [\n          { \"type\": \"text\", \"text\": \"{{ $json.nome_associado_clean }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.data_vencimento_formatada }}\" }\n        ]\n      }\n    ]\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[368,1200],"id":"fd19fc48-6949-4cba-a4e6-329d985b16ca","name":"mkt_start_app","onError":"continueRegularOutput"},{"parameters":{"path":"520cf821-0022-4265-8972-ebdcd9aba7c0","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-704,960],"id":"a9893e3c-4193-434b-9b5c-595f6dc2b77b","name":"Webhook","webhookId":"520cf821-0022-4265-8972-ebdcd9aba7c0"}],"connections":{"Schedule Trigger":{"main":[[{"node":"buscaBoletos","type":"main","index":0}]]},"loopBoletosBI":{"main":[[{"node":"Aggregate1","type":"main","index":0}],[{"node":"Code in JavaScript","type":"main","index":0}]]},"buscaBoletos":{"main":[[{"node":"loopBoletosBI","type":"main","index":0}]]},"Wait2":{"main":[[{"node":"mkt_start_app","type":"main","index":0}]]},"Send message":{"main":[[]]},"Code in JavaScript":{"main":[[{"node":"Wait2","type":"main","index":0}]]},"Aggregate1":{"main":[[{"node":"Send message","type":"main","index":0}]]},"buscaBoletos1":{"main":[[{"node":"loopBoletosBI","type":"main","index":0}]]},"mkt_start_app":{"main":[[{"node":"buscaBoletos1","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"buscaBoletos","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataErrorExecution":"all","saveDataSuccessExecution":"all","saveExecutionProgress":true,"saveManualExecutions":true,"callerPolicy":"workflowsFromSameOwner","timeSavedPerExecution":10},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Schedule Trigger1":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"2acf7a0e-b95e-4ba4-abac-6ab1a54fb002","triggerCount":2,"shared":[{"createdAt":"2025-11-18T16:56:07.433Z","updatedAt":"2025-11-18T16:56:07.433Z","role":"workflow:owner","workflowId":"jBdu97S4aDhLDdlC","projectId":"Q1ZOyZgW3upjWPqV"}],"tags":[{"createdAt":"2025-07-12T12:17:26.642Z","updatedAt":"2025-07-12T12:17:26.642Z","id":"TN2r2A362fmMHecy","name":"WHATSAPP"},{"createdAt":"2025-07-12T12:17:26.644Z","updatedAt":"2025-07-12T12:17:26.644Z","id":"pIMmsZ0yhW61pdRj","name":"MENSAGENS"}]}