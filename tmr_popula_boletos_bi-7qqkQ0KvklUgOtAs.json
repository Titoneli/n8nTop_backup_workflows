{"createdAt":"2025-09-24T20:09:18.210Z","updatedAt":"2025-11-02T06:24:55.906Z","id":"7qqkQ0KvklUgOtAs","name":"TMR_POPULA_BOLETOS_BI","active":false,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-544,96],"id":"5a6a90d5-4b32-47ed-bf3f-37e96dfbb3c3","name":"When clicking ‘Execute workflow’"},{"parameters":{},"name":"Start Loop","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-352,224],"id":"80e9e463-c55e-4074-bbd2-bde78669cb2d"},{"parameters":{"values":{"number":[{"name":"counter","value":"={{$node[\"Start Loop\"].json[\"counter\"] + 1}}"}]},"options":{}},"name":"Increment","type":"n8n-nodes-base.set","typeVersion":1,"position":[-144,224],"id":"b2e214de-1437-4105-80f2-b15c155d5512"},{"parameters":{"values":{"number":[{"name":"counter","value":"={{ $('buscaUltPagina').item.json.pagina.toNumber() }}"}]},"options":{}},"name":"Init Counter","type":"n8n-nodes-base.set","typeVersion":1,"position":[912,32],"id":"c244091f-1ca3-4e06-987a-418c8ce256f5"},{"parameters":{"conditions":{"number":[{"value1":"={{ $('Increment').item.json[\"counter\"] }}","value2":"=21"}]}},"name":"IF5","type":"n8n-nodes-base.if","typeVersion":1,"position":[-144,416],"id":"1a15cfcb-8383-4b48-bd05-7dc191562c25","notes":"{{ $('buscaQuantPaginas').item.json.body.numero_paginas }}"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"3c920d75-aaea-46f0-b73c-3590de62ebd0","leftValue":"={{ $json.error.status }}","rightValue":401,"operator":{"type":"number","operation":"equals"}},{"id":"54d76463-a28d-40bb-88fb-0ca340b6da0a","leftValue":"={{ $json.error.status }}","rightValue":403,"operator":{"type":"number","operation":"equals"}},{"id":"7b1c8240-0ddd-438c-9862-4788fbd0cf6a","leftValue":"={{ $json.error.status }}","rightValue":"400","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[480,32],"id":"e3e5f1dd-0537-43d1-adad-219106ab3c84","name":"If2","disabled":true},{"parameters":{"workflowId":{"__rl":true,"value":"N0Mpj3nRD1QnF7VH","mode":"list","cachedResultName":"WF_ATUALIZA_TOKEN_SGA"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":["base"],"schema":[{"id":"base","displayName":"base","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[704,-176],"id":"ac4a8ea8-2676-4ea4-bb14-4490c872375e","name":"Execute Workflow1","executeOnce":true,"disabled":true},{"parameters":{"operation":"get","tableId":"corDominio","filters":{"conditions":[{"keyName":"idDominio","keyValue":"domTokenSGABoletos"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[64,32],"id":"e1612bbf-571e-4158-aadc-5fd73e714b34","name":"buscaTokenBD","credentials":{"supabaseApi":{"id":"S5lx7Z0EUntC6pYv","name":"Cotacao"}}},{"parameters":{"assignments":{"assignments":[{"id":"4f98bfdb-bf33-4568-93cd-17caa7af1eac","name":"quantidadePagina","value":3000,"type":"number"},{"id":"7da3ae77-c98b-4e88-acc2-764b9430c6bc","name":"pagina","value":"={{ $('Increment').item.json.counter - 1 }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[64,224],"id":"ebc44d32-12e4-49f8-bd87-42f7f6366182","name":"dadosPagina"},{"parameters":{"method":"POST","url":"=https://api.hinova.com.br/api/sga/v2/listar/boleto-associado/periodo","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"={{ $('buscaTokenBD').item.json['descricaoDominio'] }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"data_vencimento_inicial\": \"{{ $('dadosDatas').item.json.dtVencimentoInicial }}\",\n  \"data_vencimento_final\": \"{{ $('dadosDatas').item.json.dtVencimentoFinal }}\",\n  \"link_boleto\": false,\n  \"quantidade_por_pagina\": 3000,\n  \"inicio_paginacao\": 0\n}\n","options":{"response":{"response":{"fullResponse":true}},"timeout":1000000}},"id":"6cadccb6-c783-4e90-a24b-21df61ee3b87","name":"buscaQuantPaginas","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[272,32],"retryOnFail":false,"maxTries":5,"waitBetweenTries":5000,"disabled":true,"continueOnFail":true},{"parameters":{"method":"POST","url":"=https://api.hinova.com.br/api/sga/v2/listar/boleto-associado/periodo","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"={{ $('buscaTokenBD').item.json['descricaoDominio'] }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"data_vencimento_inicial\": \"{{ $('dadosDatas').item.json.dtVencimentoInicial }}\",\n  \"data_vencimento_final\": \"{{ $('dadosDatas').item.json.dtVencimentoFinal }}\",\n  \"link_boleto\": false,\n  \"quantidade_por_pagina\": {{ $('dadosPagina').item.json.quantidadePagina }},\n  \"inicio_paginacao\": {{ $('dadosPagina').item.json.pagina }}\n}\n","options":{"response":{"response":{"fullResponse":true}},"timeout":1000000}},"id":"580bf944-f20b-4ad9-9590-ba55caf9bc09","name":"buscaBoletosPag","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[272,224],"retryOnFail":false,"waitBetweenTries":5000,"maxTries":5,"continueOnFail":true},{"parameters":{"assignments":{"assignments":[{"id":"a5ba2546-bb0c-4057-ae8e-27c8d8df705e","name":"dtVencimentoInicial","value":"={{ ('0' + 1).slice(-2) + '/' + ('0' + (new Date().getMonth() + 1)).slice(-2) + '/' + new Date().getFullYear() }}","type":"string"},{"id":"b22f66c6-314b-43d6-a3de-3cd8d2aef75a","name":"dtVencimentoFinal","value":"={{ ('0' + new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate()).slice(-2) + '/' + ('0' + (new Date().getMonth() + 1)).slice(-2) + '/' + new Date().getFullYear() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-144,32],"id":"32b92824-9ba2-451f-8f44-5d32419c3969","name":"dadosDatas"},{"parameters":{"fieldToSplitOut":"body.boletos","options":{"destinationFieldName":"boletos"}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[704,224],"id":"d1c16026-02c7-4b79-b01f-f683e382c901","name":"splitBoletos","alwaysOutputData":true},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[64,416],"id":"3d2b1c76-e66a-4bce-b578-7a04f81db3d1","name":"Aggregate1"},{"parameters":{"path":"geraboletosbi","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-544,-256],"id":"8127185b-d150-459c-b4cb-5c7597712f76","name":"Webhook","webhookId":"184d23e1-21e0-42be-a1c0-3082f6289a46","executeOnce":true},{"parameters":{"rule":{"interval":[{"triggerAtHour":2}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-544,-80],"id":"92155e52-1c16-4b39-a89a-7089f28b2249","name":"Schedule Trigger"},{"parameters":{"operation":"executeQuery","query":"delete from public.\"topBIBoletos\"\nwhere data_vencimento >= date_trunc('month', current_date);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-144,-256],"id":"d4251768-381a-447a-9f62-44dc963cc4f6","name":"Execute a SQL query1","executeOnce":true,"credentials":{"postgres":{"id":"vTHBosgrkOv6kRhi","name":"top-brasil-app-integracao"}},"disabled":true,"onError":"continueRegularOutput"},{"parameters":{"tableId":"topBIBoletosBkp","fieldsUi":{"fieldValues":[{"fieldId":"nosso_numero","fieldValue":"={{ $('splitBoletos').item.json.boletos.nosso_numero }}"},{"fieldId":"codigo_associado","fieldValue":"={{ $('splitBoletos').item.json.boletos.codigo_associado }}"},{"fieldId":"nome_associado","fieldValue":"={{ $('splitBoletos').item.json.boletos.nome_associado }}"},{"fieldId":"celular","fieldValue":"={{ $('splitBoletos').item.json.boletos.celular }}"},{"fieldId":"data_emissao","fieldValue":"={{ $('splitBoletos').item.json.boletos.data_emissao }}"},{"fieldId":"data_vencimento","fieldValue":"={{ $('splitBoletos').item.json.boletos.data_vencimento }}"},{"fieldId":"data_vencimento_original","fieldValue":"={{ $('splitBoletos').item.json.boletos.data_vencimento_original }}"},{"fieldId":"data_pagamento","fieldValue":"={{ $('splitBoletos').item.json.boletos.data_pagamento }}"},{"fieldId":"codigo_tipo_boleto","fieldValue":"={{ $('splitBoletos').item.json.boletos.codigo_tipo_boleto }}"},{"fieldId":"tipo_boleto","fieldValue":"={{ $('splitBoletos').item.json.boletos.tipo_boleto }}"},{"fieldId":"codigo_situacao_boleto","fieldValue":"={{ $('splitBoletos').item.json.boletos.codigo_situacao_boleto }}"},{"fieldId":"codigo_forma_pagamento","fieldValue":"={{ $('splitBoletos').item.json.boletos.codigo_forma_pagamento }}"},{"fieldId":"situacao_boleto","fieldValue":"={{ $('splitBoletos').item.json.boletos.situacao_boleto }}"},{"fieldId":"valor_boleto","fieldValue":"={{ $('splitBoletos').item.json.boletos.valor_boleto }}"},{"fieldId":"valor_pagamento","fieldValue":"={{ $('splitBoletos').item.json.boletos.valor_pagamento }}"},{"fieldId":"linha_digitavel","fieldValue":"={{ $('splitBoletos').item.json.boletos.linha_digitavel }}"},{"fieldId":"placa","fieldValue":"={{ $('splitBoletos').item.json.boletos.veiculos[0].placa }}"},{"fieldId":"modelo","fieldValue":"={{ $('splitBoletos').item.json.boletos.veiculos[0].modelo }}"},{"fieldId":"codigo_regional","fieldValue":"={{ $('splitBoletos').item.json.boletos.veiculos[0].codigo_regional }}"},{"fieldId":"codigo_cooperativa","fieldValue":"={{ $('splitBoletos').item.json.boletos.veiculos[0].codigo_cooperativa }}"},{"fieldId":"codigo_voluntario","fieldValue":"={{ $('splitBoletos').item.json.boletos.veiculos[0].codigo_voluntario }}"},{"fieldId":"codigo_banco","fieldValue":"={{ $('splitBoletos').item.json.boletos.codigo_banco }}"},{"fieldId":"mes_referente","fieldValue":"={{ $('splitBoletos').item.json.boletos.mes_referente }}"},{"fieldId":"situacao_veiculo","fieldValue":"={{ $('splitBoletos').item.json.boletos.veiculos[0].situacao_veiculo }}"},{"fieldId":"link_boleto","fieldValue":"={{ $('splitBoletos').item.json.boletos.link_boleto === \"Não foi possível disponibilizar esta informação pois o boleto excedeu o prazo permitido de abertura do boleto pelo associado\" ? '-' : ($('splitBoletos').item.json.boletos.link_boleto || '-') }}"},{"fieldId":"msgBoletoEnviada","fieldValue":"false"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[912,224],"id":"4afea29e-dad8-4a4a-881d-9eee9fe64281","name":"gravaBoleto1","credentials":{"supabaseApi":{"id":"VQ0u6V6adXidF31q","name":"top-brasil-app-integracao"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"WITH duplicados AS (\n    SELECT \n        \"idBIBoletos\"\n    FROM (\n        SELECT \n            \"idBIBoletos\",\n            nosso_numero,\n            ROW_NUMBER() OVER (\n                PARTITION BY nosso_numero \n                ORDER BY \"idBIBoletos\"\n            ) AS ordem\n        FROM public.\"topBIBoletos\"\n        WHERE nosso_numero IS NOT NULL\n    ) t\n    WHERE ordem > 1  -- mantém apenas os duplicados (linha 2 em diante)\n)\nDELETE FROM public.\"topBIBoletos\" b\nUSING duplicados d\nWHERE b.\"idBIBoletos\" = d.\"idBIBoletos\";","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[496,416],"id":"443755a4-0f16-4d57-9aaf-e077cf7a5ea5","name":"Execute a SQL query","executeOnce":true,"credentials":{"postgres":{"id":"vTHBosgrkOv6kRhi","name":"top-brasil-app-integracao"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"select ceil(count(*)::numeric / 3000) as pagina\nfrom public.\"topBIBoletosBkp\"\nwhere data_vencimento >= date_trunc('month', current_date);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[272,-256],"id":"eb56f6e2-3b07-4f41-813d-e9acc067dd73","name":"buscaUltPagina","executeOnce":true,"credentials":{"postgres":{"id":"vTHBosgrkOv6kRhi","name":"top-brasil-app-integracao"}},"onError":"continueRegularOutput"},{"parameters":{"unit":"minutes"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1120,224],"id":"e22875a3-792f-4e71-a3e1-079fc1dc5aec","name":"Wait","webhookId":"f87ec38f-1a4c-4106-a0aa-67b84660b0bc","executeOnce":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"3c920d75-aaea-46f0-b73c-3590de62ebd0","leftValue":"={{ $json.error.status }}","rightValue":401,"operator":{"type":"number","operation":"equals"}},{"id":"54d76463-a28d-40bb-88fb-0ca340b6da0a","leftValue":"={{ $json.error.status }}","rightValue":403,"operator":{"type":"number","operation":"equals"}},{"id":"7b1c8240-0ddd-438c-9862-4788fbd0cf6a","leftValue":"={{ $json.error.status }}","rightValue":"400","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[496,224],"id":"f346e8a7-b1ae-45d7-a8ca-c439b9294115","name":"If3"},{"parameters":{"errorMessage":"API BLOQUEADA"},"type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[1120,32],"id":"13785b3c-de04-4a7b-951d-c89de4a1d45b","name":"Stop and Error"},{"parameters":{"unit":"minutes"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[704,32],"id":"9852774f-483f-4c61-9a25-9b6391be9170","name":"Wait1","webhookId":"f87ec38f-1a4c-4106-a0aa-67b84660b0bc","disabled":true}],"connections":{"When clicking ‘Execute workflow’":{"main":[[{"node":"Execute a SQL query1","type":"main","index":0}]]},"Start Loop":{"main":[[{"node":"Increment","type":"main","index":0}]]},"Increment":{"main":[[{"node":"dadosPagina","type":"main","index":0},{"node":"IF5","type":"main","index":0}]]},"Init Counter":{"main":[[{"node":"Start Loop","type":"main","index":0}]]},"IF5":{"main":[[{"node":"Start Loop","type":"main","index":0}],[{"node":"Aggregate1","type":"main","index":0}]]},"If2":{"main":[[],[{"node":"Wait1","type":"main","index":0}]]},"Execute Workflow1":{"main":[[{"node":"buscaTokenBD","type":"main","index":0}]]},"buscaTokenBD":{"main":[[{"node":"buscaQuantPaginas","type":"main","index":0},{"node":"Init Counter","type":"main","index":0}]]},"dadosPagina":{"main":[[{"node":"buscaBoletosPag","type":"main","index":0}]]},"buscaQuantPaginas":{"main":[[{"node":"If2","type":"main","index":0}]]},"buscaBoletosPag":{"main":[[{"node":"If3","type":"main","index":0}]]},"dadosDatas":{"main":[[{"node":"buscaTokenBD","type":"main","index":0}]]},"splitBoletos":{"main":[[{"node":"gravaBoleto1","type":"main","index":0}]]},"Aggregate1":{"main":[[]]},"Webhook":{"main":[[{"node":"Execute a SQL query1","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"Execute a SQL query1","type":"main","index":0}]]},"Execute a SQL query1":{"main":[[{"node":"buscaUltPagina","type":"main","index":0}]]},"buscaUltPagina":{"main":[[{"node":"dadosDatas","type":"main","index":0}]]},"gravaBoleto1":{"main":[[{"node":"Wait","type":"main","index":0}]]},"If3":{"main":[[{"node":"Stop and Error","type":"main","index":0}],[{"node":"splitBoletos","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"Init Counter","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataErrorExecution":"all","saveDataSuccessExecution":"none","saveExecutionProgress":false,"saveManualExecutions":false,"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"TfwD6eX8vHLcjYJt"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Schedule Trigger1":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"2cf0a3e0-ac34-4597-9980-13a27be3c372","triggerCount":2,"shared":[{"createdAt":"2025-09-24T20:09:18.210Z","updatedAt":"2025-09-24T20:09:18.210Z","role":"workflow:owner","workflowId":"7qqkQ0KvklUgOtAs","projectId":"Q1ZOyZgW3upjWPqV"}],"tags":[{"createdAt":"2025-09-24T20:09:10.216Z","updatedAt":"2025-09-24T20:09:10.216Z","id":"unxeE4bOTKE0sCc3","name":"BI"}]}