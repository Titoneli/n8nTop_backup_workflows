{"createdAt":"2026-01-05T19:36:47.655Z","updatedAt":"2026-01-12T22:02:15.495Z","id":"q580Zgsew3J6FpF8","name":"TMR_MSG_SMS_ZENVIA_BOLETOS_BD_ERP","active":true,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-1312,1312],"id":"0a8a6d08-c54d-4b44-a1f0-220e22820b9a","name":"When clicking ‘Execute workflow’"},{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"20 02 * * 1-5"}]}},"id":"b0c77e8f-c295-43e4-8177-53aa49c85836","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[-1312,1120]},{"parameters":{"values":{"number":[{"name":"counter"}]},"options":{}},"name":"Init Counter","type":"n8n-nodes-base.set","typeVersion":1,"position":[-416,1216],"id":"4306d2ec-15ee-4663-b0b6-711cf2c53c6f"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-1088,1216],"id":"43067d0b-9ca2-4a05-ad37-db74d2c9fb63","name":"No Operation, do nothing1"},{"parameters":{"workflowId":{"__rl":true,"value":"2VuemE7VvQrM65uQ","mode":"list","cachedResultUrl":"/workflow/2VuemE7VvQrM65uQ","cachedResultName":"TMR_POPULA_TOP_BOLETOS"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dataVInicial":"={{\n  (() => {\n    let d = new Date();\n    d.setDate(d.getDate() - 5); // começa 5 dia após o vencimento\n\n    // enquanto for segunda (1), retrocede + 9 dias\n    while (d.getDay() === 1) {\n      d.setDate(d.getDate() - 8);\n    }\n\n    // formata para dd/MM/yyyy\n    const dd = String(d.getDate()).padStart(2, '0');\n    const mm = String(d.getMonth() + 1).padStart(2, '0');\n    const yyyy = d.getFullYear();\n\n    return `${dd}/${mm}/${yyyy}`;\n  })()\n}}"},"matchingColumns":["origem"],"schema":[{"id":"dataVInicial","displayName":"dataVInicial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-864,1216],"id":"a925012d-2d47-4862-bcd0-5719457748dd","name":"AtualizaBoletos","disabled":true},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-640,1216],"id":"819cd3f6-c131-4a82-9732-a0831f4ee087","name":"Aggregate4"},{"parameters":{"method":"POST","url":"https://api.zenvia.com/v2/channels/sms/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-API-TOKEN","value":"FfLUl-xKIxTAOEOEkLp5fgt24-c8zk8QtSJv"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"from\": \"lembranca\",\n  \"to\": \"{{ $('dadosLoop').item.json.celular_associado }}\",\n  \"contents\": [\n    {\n      \"type\": \"text\",\n      \"text\": \"{{$('dadosMensagem').item.json.mensagem }}\"\n    }\n  ]\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1168,1008],"id":"9d1ab679-99c8-46aa-b8f7-a4bcaf01856f","name":"smsZenviaPVCE","alwaysOutputData":true,"executeOnce":true,"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eca47edb-494d-4817-a8de-f54d74458b2f","leftValue":"={{ $('verificaFeriado3').item.json.isHoliday }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"496514d7-b372-43dc-9576-0fbae277ab0a","leftValue":"={{ $json.holiday.type }}","rightValue":"facultativo","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[272,800],"id":"31835198-aec1-46f6-9f41-b60034beead5","name":"If3"},{"parameters":{"workflowId":{"__rl":true,"value":"QV6HWDmqkiXXdyFk","mode":"list","cachedResultUrl":"/workflow/QV6HWDmqkiXXdyFk","cachedResultName":"SUB_VERIFICA_FERIADO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data":"={{ $('dadosPaginaVencD-0_SMS').item.json.dtVencimento }}"},"matchingColumns":[],"schema":[{"id":"data","displayName":"data","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[48,800],"id":"d5bce89a-f136-4070-bb76-25d49d6bf444","name":"verificaFeriado3"},{"parameters":{"assignments":{"assignments":[{"id":"bd448a7b-74b4-4d15-b1b2-55d1ffae25bb","name":"nome_associado","value":"={{\n(() => {\n  const nome = ($json.nome_associado || '')\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .trim()\n    .toLowerCase()\n    .split(/\\s+/);\n\n  if (!nome.length) return '';\n\n  const cap = s => s.charAt(0).toUpperCase() + s.slice(1);\n\n  return nome.length > 1\n    ? `${cap(nome[0])} ${cap(nome[nome.length - 1])}`\n    : cap(nome[0]);\n})()\n}}","type":"string"},{"id":"a3aeb4f0-662c-42aa-855c-1621be3f96d3","name":"celular_associado","value":"={{'55'+$('loopSMSBoletos').item.json.celular.match( /\\d+/g ).join('')}}","type":"string"},{"id":"4f75d997-9b52-46a8-9fd5-089769dec633","name":"placa","value":"={{ $json.placa }}","type":"string"},{"id":"8e23ffe7-9157-4f0c-9ed8-fd7639137d96","name":"nosso_numero","value":"={{ $json.nosso_numero }}","type":"string"},{"id":"22c21721-a0a6-4322-b899-d134d161f844","name":"data_vencimento","value":"={{ $json.data_vencimento.toDateTime().format('yyyy-MM-dd') }}","type":"string"},{"id":"3c41cc18-a96a-493d-9bad-4aae17537c17","name":"tipo_boleto","value":"={{ $json.tipo_boleto }}","type":"string"},{"id":"bda41740-30c9-45bf-b2fc-6a9537ca418d","name":"valor_boleto","value":"={{ $json.valor_boleto }}","type":"string"},{"id":"6c5de1fb-6dc9-4a73-955c-d751e5673887","name":"link_boleto","value":"={{ $json.link_boleto }}","type":"string"},{"id":"6c2e85d4-335c-4ade-b75c-2d5d05c00448","name":"mes_referente","value":"={{ $json.mes_referente }}","type":"string"},{"id":"c335076f-6258-4e78-b380-074460bcc495","name":"situacao_veiculo","value":"={{ $json.situacao_veiculo }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[736,1008],"id":"1b7ce18d-14b7-4918-bd02-819e9dcfdce1","name":"dadosLoop"},{"parameters":{"assignments":{"assignments":[{"id":"625e8b1a-9517-4ac2-873e-d11c7625d2a6","name":"mensagem","value":"=Ola {{ $json.nome_associado }}, somos da Top Brasil.\\nSeu boleto vence hoje {{ $('loopSMSBoletos').item.json.data_vencimento.toDateTime().format('dd/MM/yyyy') }}!\\nPDF do Boleto: {{ $('loopSMSBoletos').item.json.link_boleto }}\\nDuvidas, entre em contato atraves da nossa central: 31 982073313","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[944,1008],"id":"a45a7e6c-78c9-4b65-90df-35b5c606238c","name":"dadosMensagem"},{"parameters":{"operation":"executeQuery","query":"UPDATE topBIBoletos\nSET msg_sms_znv_diavencimento = true, dth_envio_sms_znv_diavencimento = CURRENT_TIMESTAMP, msg_texto_sms_znv_diavencimento = $2 \nWHERE nosso_numero = $1;","options":{"queryReplacement":"={{\n[\n  $('loopSMSBoletos').item.json.nosso_numero,\n  $('smsZenviaPVCE').item.json.id + ' - ' +  $json.contents[0].text\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1360,1008],"id":"7a43aa2a-bfbb-4570-a56c-e975a4c8a063","name":"Execute a SQL query","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}},"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[720,800],"id":"e1783d76-130d-47c2-9a60-42c31afe6cc6","name":"loopSMSBoletos"},{"parameters":{"method":"POST","url":"https://api.zenvia.com/v2/channels/sms/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-API-TOKEN","value":"FfLUl-xKIxTAOEOEkLp5fgt24-c8zk8QtSJv"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"from\": \"lembranca\",\n  \"to\": \"{{ $('dadosLoop1').item.json.celular_associado }}\",\n  \"contents\": [\n    {\n      \"type\": \"text\",\n      \"text\": \"{{$('dadosMensagem1').item.json.mensagem }}\"\n    }\n  ]\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1600,1840],"id":"b9bff6f1-8c69-4c38-95e3-4867940a51b7","name":"smsZenviaPVCE1","onError":"continueRegularOutput"},{"parameters":{"assignments":{"assignments":[{"id":"bd448a7b-74b4-4d15-b1b2-55d1ffae25bb","name":"nome_associado","value":"={{\n(() => {\n  const nome = ($json.nome_associado || '')\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .trim()\n    .toLowerCase()\n    .split(/\\s+/);\n\n  if (!nome.length) return '';\n\n  const cap = s => s.charAt(0).toUpperCase() + s.slice(1);\n\n  return nome.length > 1\n    ? `${cap(nome[0])} ${cap(nome[nome.length - 1])}`\n    : cap(nome[0]);\n})()\n}}","type":"string"},{"id":"a3aeb4f0-662c-42aa-855c-1621be3f96d3","name":"celular_associado","value":"={{'55'+$('loopSMSBoletos1').item.json.celular.match( /\\d+/g ).join('')}}","type":"string"},{"id":"4f75d997-9b52-46a8-9fd5-089769dec633","name":"placa","value":"={{ $json.placa }}","type":"string"},{"id":"8e23ffe7-9157-4f0c-9ed8-fd7639137d96","name":"nosso_numero","value":"={{ $json.nosso_numero }}","type":"string"},{"id":"22c21721-a0a6-4322-b899-d134d161f844","name":"data_vencimento","value":"={{ $json.data_vencimento.toDateTime().format('yyyy-MM-dd') }}","type":"string"},{"id":"3c41cc18-a96a-493d-9bad-4aae17537c17","name":"tipo_boleto","value":"={{ $json.tipo_boleto }}","type":"string"},{"id":"bda41740-30c9-45bf-b2fc-6a9537ca418d","name":"valor_boleto","value":"={{ $json.valor_boleto }}","type":"string"},{"id":"6c5de1fb-6dc9-4a73-955c-d751e5673887","name":"link_boleto","value":"={{ $json.link_boleto }}","type":"string"},{"id":"6c2e85d4-335c-4ade-b75c-2d5d05c00448","name":"mes_referente","value":"={{ $json.mes_referente }}","type":"string"},{"id":"c335076f-6258-4e78-b380-074460bcc495","name":"situacao_veiculo","value":"={{ $json.situacao_veiculo }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1168,1840],"id":"958e82ea-1768-46ea-a218-7bbdc699173a","name":"dadosLoop1"},{"parameters":{"assignments":{"assignments":[{"id":"625e8b1a-9517-4ac2-873e-d11c7625d2a6","name":"mensagem","value":"=Ola {{ $json.nome_associado }}, somos da Top Brasil.\\nSeu boleto vence hoje {{ $('loopSMSBoletos1').item.json.data_vencimento.toDateTime().format('dd/MM/yyyy') }}!\\nPDF do Boleto: {{ $('loopSMSBoletos1').item.json.link_boleto }}\\nDuvidas, entre em contato atraves da nossa central: 31 982073313","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1392,1840],"id":"1c4a5d1f-ca23-41cb-a147-1058b48c684f","name":"dadosMensagem1"},{"parameters":{"operation":"executeQuery","query":"UPDATE topBIBoletos\nSET msg_sms_znv_diavencimento = true, dth_envio_sms_znv_diavencimento = CURRENT_TIMESTAMP, msg_texto_sms_znv_diavencimento = $2 \nWHERE nosso_numero = $1;","options":{"queryReplacement":"={{\n[\n  $('loopSMSBoletos1').item.json.nosso_numero,\n  $('smsZenviaPVCE1').item.json.id + ' - ' +  $json.contents[0].text\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1808,1840],"id":"ee423e68-3da6-42ca-a4c3-b267ba1e3786","name":"Execute a SQL query1","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}},"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1168,1632],"id":"58fee6a0-07e9-4826-9254-75abd4638cd2","name":"loopSMSBoletos1"},{"parameters":{"method":"POST","url":"https://api.zenvia.com/v2/channels/sms/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-API-TOKEN","value":"FfLUl-xKIxTAOEOEkLp5fgt24-c8zk8QtSJv"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"from\": \"lembranca\",\n  \"to\": \"{{ $('dadosLoop2').item.json.celular_associado }}\",\n  \"contents\": [\n    {\n      \"type\": \"text\",\n      \"text\": \"{{$('dadosMensagem2').item.json.mensagem }}\"\n    }\n  ]\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1168,1424],"id":"49409f11-3e88-431b-ac81-8563c87d49bb","name":"smsZenviaPVCE2","onError":"continueRegularOutput"},{"parameters":{"assignments":{"assignments":[{"id":"bd448a7b-74b4-4d15-b1b2-55d1ffae25bb","name":"nome_associado","value":"={{\n(() => {\n  const nome = ($json.nome_associado || '')\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .trim()\n    .toLowerCase()\n    .split(/\\s+/);\n\n  if (!nome.length) return '';\n\n  const cap = s => s.charAt(0).toUpperCase() + s.slice(1);\n\n  return nome.length > 1\n    ? `${cap(nome[0])} ${cap(nome[nome.length - 1])}`\n    : cap(nome[0]);\n})()\n}}","type":"string"},{"id":"a3aeb4f0-662c-42aa-855c-1621be3f96d3","name":"celular_associado","value":"={{'55'+$('loopSMSBoletos2').item.json.celular.match( /\\d+/g ).join('')}}","type":"string"},{"id":"4f75d997-9b52-46a8-9fd5-089769dec633","name":"placa","value":"={{ $json.placa }}","type":"string"},{"id":"8e23ffe7-9157-4f0c-9ed8-fd7639137d96","name":"nosso_numero","value":"={{ $json.nosso_numero }}","type":"string"},{"id":"22c21721-a0a6-4322-b899-d134d161f844","name":"data_vencimento","value":"={{ $json.data_vencimento.toDateTime().format('yyyy-MM-dd') }}","type":"string"},{"id":"3c41cc18-a96a-493d-9bad-4aae17537c17","name":"tipo_boleto","value":"={{ $json.tipo_boleto }}","type":"string"},{"id":"bda41740-30c9-45bf-b2fc-6a9537ca418d","name":"valor_boleto","value":"={{ $json.valor_boleto }}","type":"string"},{"id":"6c5de1fb-6dc9-4a73-955c-d751e5673887","name":"link_boleto","value":"={{ $json.link_boleto }}","type":"string"},{"id":"6c2e85d4-335c-4ade-b75c-2d5d05c00448","name":"mes_referente","value":"={{ $json.mes_referente }}","type":"string"},{"id":"c335076f-6258-4e78-b380-074460bcc495","name":"situacao_veiculo","value":"={{ $json.situacao_veiculo }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[720,1424],"id":"ece9f322-0c94-4437-a4cf-290cd7039059","name":"dadosLoop2"},{"parameters":{"assignments":{"assignments":[{"id":"625e8b1a-9517-4ac2-873e-d11c7625d2a6","name":"mensagem","value":"=Ola {{ $json.nome_associado }}, somos da Top Brasil.\\nSeu boleto vence hoje {{ $('loopSMSBoletos2').item.json.data_vencimento.toDateTime().format('dd/MM/yyyy') }}!\\nPDF do Boleto: {{ $('loopSMSBoletos2').item.json.link_boleto }}\\nDuvidas, entre em contato atraves da nossa central: 31 982073313","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[944,1424],"id":"1e358d6e-fb82-4e83-ab89-4fa39fdd8adb","name":"dadosMensagem2"},{"parameters":{"operation":"executeQuery","query":"UPDATE topBIBoletos\nSET msg_sms_znv_diavencimento = true, dth_envio_sms_znv_diavencimento = CURRENT_TIMESTAMP, msg_texto_sms_znv_diavencimento = $2 \nWHERE nosso_numero = $1;","options":{"queryReplacement":"={{\n[\n  $('loopSMSBoletos2').item.json.nosso_numero,\n  $('smsZenviaPVCE2').item.json.id + ' - ' +  $json.contents[0].text\n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1392,1424],"id":"63680812-49eb-4103-951f-416862f83907","name":"Execute a SQL query2","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}},"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[720,1216],"id":"36d84a16-7de6-4691-a04e-3971d6704859","name":"loopSMSBoletos2"},{"parameters":{"operation":"executeQuery","query":"select *\nfrom topBIBoletos\nwhere data_vencimento = $1\n  and codigo_situacao_boleto = '2'\n  and codigo_regional = '229'\n  and codigo_cooperativa = '39'\n  and situacao_boleto = 'ABERTO'\n  and tipo_boleto in ('FECHAMENTO')  \norder by codigo_voluntario asc","options":{"queryReplacement":"={{ [$('dadosPaginaVencD-5_SMS').item.json.dtVencimento ?? null] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[496,1216],"id":"bd2da51c-9218-488a-bf28-7c3242207da9","name":"buscaBoletosTOP_CO_D-5_SMS","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"operation":"executeQuery","query":"select *\nfrom topBIBoletos\nwhere data_vencimento_original = $1\n  and codigo_situacao_boleto = '2'\n  and situacao_boleto = 'ABERTO'\n  and tipo_boleto in ('FECHAMENTO')  \n  and msg_sms_znv_diavencimento = false\norder by codigo_voluntario asc","options":{"queryReplacement":"={{ [$('dadosPaginaVencD-0_SMS').item.json.dtVencimento ?? null] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[496,800],"id":"a10ee18e-10f0-4e49-87e4-e34b5f4d8b8a","name":"buscaBoletosTOP_PVCECO_D-0_SMS","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"operation":"executeQuery","query":"select *\nfrom topBIBoletos\nwhere data_vencimento_original = $1\n  and codigo_situacao_boleto = '2'\n  and situacao_boleto = 'ABERTO'\n  and tipo_boleto in ('FECHAMENTO')  \norder by codigo_voluntario asc","options":{"queryReplacement":"={{ [$('dadosPaginaVencD-2_SMS1').item.json.dtVencimento ?? null] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[944,1632],"id":"b58599cb-58a9-42ed-883c-8d7c5231ae83","name":"buscaBoletosTOP_PVCE_D-2_SMS","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"assignments":{"assignments":[{"id":"4f98bfdb-bf33-4568-93cd-17caa7af1eac","name":"quantidadePagina","value":3000,"type":"number"},{"id":"7da3ae77-c98b-4e88-acc2-764b9430c6bc","name":"pagina","value":"=0","type":"number"},{"id":"a5ba2546-bb0c-4057-ae8e-27c8d8df705e","name":"dtVencimento","value":"={{ $json.data_vencimento?.toDateTime()?.format('yyyy/MM/dd') || null }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[272,1216],"id":"5701f617-4ac0-4de0-9796-cc47fb8aa0a4","name":"dadosPaginaVencD-5_SMS"},{"parameters":{"assignments":{"assignments":[{"id":"4f98bfdb-bf33-4568-93cd-17caa7af1eac","name":"quantidadePagina","value":3000,"type":"number"},{"id":"7da3ae77-c98b-4e88-acc2-764b9430c6bc","name":"pagina","value":"=0","type":"number"},{"id":"a5ba2546-bb0c-4057-ae8e-27c8d8df705e","name":"dtVencimento","value":"={{\n  (() => {\n    let d = new Date();\n    d.setDate(d.getDate()); // começa 5 dia após o vencimento\n\n    // enquanto for segunda (1), retrocede + 9 dias\n    while (d.getDay() === 0) {\n      d.setDate(d.getDate() - 2);\n    }\n\n    // formata para dd/MM/yyyy\n    const dd = String(d.getDate()).padStart(2, '0');\n    const mm = String(d.getMonth() + 1).padStart(2, '0');\n    const yyyy = d.getFullYear();\n\n    return `${yyyy}/${mm}/${dd}`;\n  })()\n}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-176,800],"id":"0e394bd4-3882-4e71-b137-f0ace87bdfbd","name":"dadosPaginaVencD-0_SMS"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eca47edb-494d-4817-a8de-f54d74458b2f","leftValue":"={{ $('verificaFeriado4').item.json.isHoliday }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"66e001cb-9181-4fc0-afd7-7bbf85150028","leftValue":"={{ $json.holiday.type }}","rightValue":"facultativo","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[720,1632],"id":"a471b74c-6230-485b-b8e2-b3d3fbec1dc7","name":"If4"},{"parameters":{"workflowId":{"__rl":true,"value":"QV6HWDmqkiXXdyFk","mode":"list","cachedResultUrl":"/workflow/QV6HWDmqkiXXdyFk","cachedResultName":"SUB_VERIFICA_FERIADO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data":"={{ $('dadosPaginaVencD-2_SMS1').item.json.dtVencimento }}"},"matchingColumns":[],"schema":[{"id":"data","displayName":"data","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[496,1632],"id":"119f8e5e-a118-40ad-b794-370316299833","name":"verificaFeriado4"},{"parameters":{"assignments":{"assignments":[{"id":"4f98bfdb-bf33-4568-93cd-17caa7af1eac","name":"quantidadePagina","value":3000,"type":"number"},{"id":"7da3ae77-c98b-4e88-acc2-764b9430c6bc","name":"pagina","value":"=0","type":"number"},{"id":"a5ba2546-bb0c-4057-ae8e-27c8d8df705e","name":"dtVencimento","value":"={{ $json.data_vencimento?.toDateTime()?.format('yyyy/MM/dd') || null }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[272,1632],"id":"fa4a25d9-5bb1-49da-bd12-7fdaa818ad93","name":"dadosPaginaVencD-2_SMS1"},{"parameters":{"operation":"executeQuery","query":"UPDATE topBIBoletos\nSET msg_sms_znv_diavencimento = true, dth_envio_sms_znv_diavencimento = CURRENT_TIMESTAMP \nwhere data_vencimento_original = $1\n  and codigo_situacao_boleto = '2'\n  and situacao_boleto = 'ABERTO'\n  and tipo_boleto in ('FECHAMENTO')  ","options":{"queryReplacement":"={{\n[\n [$('dadosPaginaVencD-2_SMS1').item.json.dtVencimento ?? null] \n]\n}}\n"}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[1600,1632],"id":"d1b07005-b5e2-4121-a37a-97e3669590c9","name":"buscaBoletosTOP_PVCE_D-2_SMS1","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}},"disabled":true},{"parameters":{"operation":"executeQuery","query":"UPDATE topBIBoletos\nSET msg_sms_znv_diavencimento = true, dth_envio_sms_znv_diavencimento = CURRENT_TIMESTAMP\nwhere data_vencimento = $1\n  and codigo_situacao_boleto = '2'\n  and codigo_regional = '229'\n  and codigo_cooperativa = '39'\n  and situacao_boleto = 'ABERTO'\n  and tipo_boleto in ('FECHAMENTO');","options":{"queryReplacement":"={{\n[\n [$('dadosPaginaVencD-5_SMS').item.json.dtVencimento ?? null] \n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[1168,1216],"id":"734e7b69-be35-46db-ac0e-2569f8dbf9d5","name":"buscaBoletosTOP_PVCE_D-2_SMS2","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"operation":"executeQuery","query":"UPDATE topBIBoletos\nSET msg_sms_znv_diavencimento = true, dth_envio_sms_znv_diavencimento = CURRENT_TIMESTAMP\nwhere data_vencimento = $1\n  and codigo_situacao_boleto = '2'\n  and codigo_regional = '229'\n  and codigo_cooperativa = '39'\n  and situacao_boleto = 'ABERTO'\n  and tipo_boleto in ('FECHAMENTO');","options":{"queryReplacement":"={{\n[\n [$('dadosPaginaVencD-0_SMS').item.json.dtVencimento ?? null] \n]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[1168,800],"id":"7ee22c61-69f3-4698-90d5-f23c59f13787","name":"buscaBoletosTOP_PVCE_D-2_SMS3","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"operation":"executeQuery","query":"WITH vencimentos AS (\n    SELECT unnest(ARRAY[5,10,15,20,25,26,30]) AS dia_vencimento\n),\nbase AS (\n    SELECT\n        dia_vencimento,\n        make_date(\n            EXTRACT(YEAR FROM CURRENT_DATE)::int,\n            EXTRACT(MONTH FROM CURRENT_DATE)::int,\n            dia_vencimento\n        ) AS data_vencimento_original\n    FROM vencimentos\n),\ncalculado AS (\n    SELECT\n        b.dia_vencimento,\n        b.data_vencimento_original,\n        CASE\n            WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                THEN b.data_vencimento_original + INTERVAL '2 days'\n            WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                THEN b.data_vencimento_original + INTERVAL '1 day'\n            ELSE b.data_vencimento_original\n        END::date AS data_base_ajustada,\n        (\n            CASE\n                WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                    THEN b.data_vencimento_original + INTERVAL '2 days'\n                WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                    THEN b.data_vencimento_original + INTERVAL '1 day'\n                ELSE b.data_vencimento_original\n            END\n            + INTERVAL '4 days'\n        )::date AS data_5_dias_corridos,\n        (\n            SELECT d::date\n            FROM generate_series(\n                (\n                    CASE\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                            THEN b.data_vencimento_original + INTERVAL '2 days'\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                            THEN b.data_vencimento_original + INTERVAL '1 day'\n                        ELSE b.data_vencimento_original\n                    END\n                ) + INTERVAL '1 day',\n                (\n                    CASE\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                            THEN b.data_vencimento_original + INTERVAL '2 days'\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                            THEN b.data_vencimento_original + INTERVAL '1 day'\n                        ELSE b.data_vencimento_original\n                    END\n                ) + INTERVAL '10 days',\n                INTERVAL '1 day'\n            ) AS d\n            WHERE EXTRACT(DOW FROM d) NOT IN (0,6)\n            ORDER BY d\n            OFFSET 1\n            LIMIT 1\n        ) AS data_2_dias_uteis\n    FROM base b\n),\nresultado AS (\n    SELECT\n        dia_vencimento,\n        data_vencimento_original::date AS data_vencimento,\n        data_5_dias_corridos,\n        data_2_dias_uteis\n    FROM calculado\n    WHERE data_5_dias_corridos = CURRENT_DATE)\nSELECT *\nFROM resultado\nUNION ALL\nSELECT\n    NULL::int  AS dia_vencimento,\n    NULL::date AS data_vencimento,\n    NULL::date AS data_5_dias_corridos,\n    NULL::date AS data_2_dias_uteis\nWHERE NOT EXISTS (SELECT 1 FROM resultado);\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-176,1216],"id":"385660dc-6bd3-4b54-b9cd-b8b9fd775793","name":"buscaBoletosTOP_CO_D-5_SMS1","alwaysOutputData":true,"credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"operation":"executeQuery","query":"WITH vencimentos AS (\n    SELECT unnest(ARRAY[5,10,15,20,25,26,30]) AS dia_vencimento\n),\nbase AS (\n    SELECT\n        dia_vencimento,\n        make_date(\n            EXTRACT(YEAR FROM CURRENT_DATE)::int,\n            EXTRACT(MONTH FROM CURRENT_DATE)::int,\n            dia_vencimento\n        ) AS data_vencimento_original\n    FROM vencimentos\n),\ncalculado AS (\n    SELECT\n        b.dia_vencimento,\n        b.data_vencimento_original,\n        CASE\n            WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                THEN b.data_vencimento_original + INTERVAL '2 days'\n            WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                THEN b.data_vencimento_original + INTERVAL '1 day'\n            ELSE b.data_vencimento_original\n        END::date AS data_base_ajustada,\n        (\n            CASE\n                WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                    THEN b.data_vencimento_original + INTERVAL '2 days'\n                WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                    THEN b.data_vencimento_original + INTERVAL '1 day'\n                ELSE b.data_vencimento_original\n            END\n            + INTERVAL '4 days'\n        )::date AS data_5_dias_corridos,\n        (\n            SELECT d::date\n            FROM generate_series(\n                (\n                    CASE\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                            THEN b.data_vencimento_original + INTERVAL '2 days'\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                            THEN b.data_vencimento_original + INTERVAL '1 day'\n                        ELSE b.data_vencimento_original\n                    END\n                ) + INTERVAL '1 day',\n                (\n                    CASE\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                            THEN b.data_vencimento_original + INTERVAL '2 days'\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                            THEN b.data_vencimento_original + INTERVAL '1 day'\n                        ELSE b.data_vencimento_original\n                    END\n                ) + INTERVAL '10 days',\n                INTERVAL '1 day'\n            ) AS d\n            WHERE EXTRACT(DOW FROM d) NOT IN (0,6)\n            ORDER BY d\n            OFFSET 1\n            LIMIT 1\n        ) AS data_2_dias_uteis\n    FROM base b\n),\nresultado AS (\n    SELECT\n        dia_vencimento,\n        data_vencimento_original::date AS data_vencimento,\n        data_5_dias_corridos,\n        data_2_dias_uteis\n    FROM calculado\n    WHERE data_2_dias_uteis = CURRENT_DATE)\nSELECT *\nFROM resultado\nUNION ALL\nSELECT\n    NULL::int  AS dia_vencimento,\n    NULL::date AS data_vencimento,\n    NULL::date AS data_5_dias_corridos,\n    NULL::date AS data_2_dias_uteis\nWHERE NOT EXISTS (SELECT 1 FROM resultado);\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-176,1632],"id":"ebc9cdf2-9c19-477d-8c3b-746fd639b0c3","name":"buscaBoletosTOP_2D_UTEIS","alwaysOutputData":true,"credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b40f6db2-e195-4b81-9a38-4e9205aec686","leftValue":"={{ $json.data_2_dias_uteis?.toDateTime()?.format('yyyy/MM/dd') || null }}","rightValue":"={{ $now.format('yyyy-MM-dd') }}","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[48,1632],"id":"239ae82b-6b5b-4e0d-8122-6431470f2871","name":"If"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b40f6db2-e195-4b81-9a38-4e9205aec686","leftValue":"={{ $json.data_5_dias_corridos?.toDateTime()?.format('yyyy-MM-dd') }}","rightValue":"={{ $now.format('yyyy-MM-dd') }}","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[32,1216],"id":"77c43904-8f81-4ef4-8ac6-c5691b034af8","name":"If1"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[944,800],"id":"7c039a8c-8a46-4cf9-8dda-904ec51f6461","name":"Aggregate"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[944,1216],"id":"180607c6-848e-43e7-8e64-073fb91ea6d6","name":"Aggregate1"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1392,1632],"id":"427315dc-e90a-40a3-b574-3c5a7fa33028","name":"Aggregate2"},{"parameters":{"path":"229d65e7-a6c5-44a3-a58c-d8ec60d181ee","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-1312,928],"id":"f03867be-ca81-4a60-84d8-360e927e0118","name":"Webhook","webhookId":"229d65e7-a6c5-44a3-a58c-d8ec60d181ee"}],"connections":{"When clicking ‘Execute workflow’":{"main":[[{"node":"No Operation, do nothing1","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"No Operation, do nothing1","type":"main","index":0}]]},"Init Counter":{"main":[[{"node":"dadosPaginaVencD-0_SMS","type":"main","index":0},{"node":"buscaBoletosTOP_CO_D-5_SMS1","type":"main","index":0},{"node":"buscaBoletosTOP_2D_UTEIS","type":"main","index":0}]]},"No Operation, do nothing1":{"main":[[{"node":"AtualizaBoletos","type":"main","index":0}]]},"AtualizaBoletos":{"main":[[{"node":"Aggregate4","type":"main","index":0}]]},"Aggregate4":{"main":[[{"node":"Init Counter","type":"main","index":0}]]},"If3":{"main":[[{"node":"buscaBoletosTOP_PVCECO_D-0_SMS","type":"main","index":0}]]},"verificaFeriado3":{"main":[[{"node":"If3","type":"main","index":0}]]},"dadosLoop":{"main":[[{"node":"dadosMensagem","type":"main","index":0}]]},"dadosMensagem":{"main":[[{"node":"smsZenviaPVCE","type":"main","index":0}]]},"smsZenviaPVCE":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"loopSMSBoletos","type":"main","index":0}]]},"loopSMSBoletos":{"main":[[{"node":"Aggregate","type":"main","index":0}],[{"node":"dadosLoop","type":"main","index":0}]]},"smsZenviaPVCE1":{"main":[[{"node":"Execute a SQL query1","type":"main","index":0}]]},"dadosLoop1":{"main":[[{"node":"dadosMensagem1","type":"main","index":0}]]},"dadosMensagem1":{"main":[[{"node":"smsZenviaPVCE1","type":"main","index":0}]]},"Execute a SQL query1":{"main":[[{"node":"loopSMSBoletos1","type":"main","index":0}]]},"loopSMSBoletos1":{"main":[[{"node":"Aggregate2","type":"main","index":0}],[{"node":"dadosLoop1","type":"main","index":0}]]},"smsZenviaPVCE2":{"main":[[{"node":"Execute a SQL query2","type":"main","index":0}]]},"dadosLoop2":{"main":[[{"node":"dadosMensagem2","type":"main","index":0}]]},"dadosMensagem2":{"main":[[{"node":"smsZenviaPVCE2","type":"main","index":0}]]},"Execute a SQL query2":{"main":[[{"node":"loopSMSBoletos2","type":"main","index":0}]]},"loopSMSBoletos2":{"main":[[{"node":"Aggregate1","type":"main","index":0}],[{"node":"dadosLoop2","type":"main","index":0}]]},"buscaBoletosTOP_CO_D-5_SMS":{"main":[[{"node":"loopSMSBoletos2","type":"main","index":0}]]},"buscaBoletosTOP_PVCECO_D-0_SMS":{"main":[[{"node":"loopSMSBoletos","type":"main","index":0}]]},"buscaBoletosTOP_PVCE_D-2_SMS":{"main":[[{"node":"loopSMSBoletos1","type":"main","index":0}]]},"dadosPaginaVencD-5_SMS":{"main":[[{"node":"buscaBoletosTOP_CO_D-5_SMS","type":"main","index":0}]]},"dadosPaginaVencD-0_SMS":{"main":[[{"node":"verificaFeriado3","type":"main","index":0}]]},"verificaFeriado4":{"main":[[{"node":"If4","type":"main","index":0}]]},"If4":{"main":[[{"node":"buscaBoletosTOP_PVCE_D-2_SMS","type":"main","index":0}]]},"dadosPaginaVencD-2_SMS1":{"main":[[{"node":"verificaFeriado4","type":"main","index":0}]]},"buscaBoletosTOP_CO_D-5_SMS1":{"main":[[{"node":"If1","type":"main","index":0}]]},"buscaBoletosTOP_2D_UTEIS":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"dadosPaginaVencD-2_SMS1","type":"main","index":0}]]},"If1":{"main":[[{"node":"dadosPaginaVencD-5_SMS","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"buscaBoletosTOP_PVCE_D-2_SMS3","type":"main","index":0}]]},"Aggregate1":{"main":[[{"node":"buscaBoletosTOP_PVCE_D-2_SMS2","type":"main","index":0}]]},"Aggregate2":{"main":[[{"node":"buscaBoletosTOP_PVCE_D-2_SMS1","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"No Operation, do nothing1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataErrorExecution":"all","saveDataSuccessExecution":"all","saveExecutionProgress":true,"saveManualExecutions":true,"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"TfwD6eX8vHLcjYJt","timeSavedPerExecution":2},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"fd362a44-69db-40b5-8180-6cdff47bd39d","triggerCount":2,"shared":[{"createdAt":"2026-01-05T19:36:47.655Z","updatedAt":"2026-01-05T19:36:47.655Z","role":"workflow:owner","workflowId":"q580Zgsew3J6FpF8","projectId":"Q1ZOyZgW3upjWPqV"}],"tags":[{"createdAt":"2025-11-27T19:20:14.981Z","updatedAt":"2025-11-27T19:20:14.981Z","id":"G1PiCFR214hWj5Im","name":"BDERP"}]}