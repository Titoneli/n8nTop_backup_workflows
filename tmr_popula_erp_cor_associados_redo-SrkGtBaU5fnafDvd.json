{"createdAt":"2025-11-03T18:39:21.592Z","updatedAt":"2025-11-03T19:25:11.405Z","id":"SrkGtBaU5fnafDvd","name":"TMR_POPULA_ERP_COR_ASSOCIADOS_REDO","active":true,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-928,544],"id":"140e8955-9f3d-4f4d-9ed8-9bf244ef29a6","name":"When clicking ‚ÄòExecute workflow‚Äô","executeOnce":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"3c920d75-aaea-46f0-b73c-3590de62ebd0","leftValue":"={{ $json.error.status }}","rightValue":401,"operator":{"type":"number","operation":"equals"}},{"id":"54d76463-a28d-40bb-88fb-0ca340b6da0a","leftValue":"={{ $json.error.status }}","rightValue":403,"operator":{"type":"number","operation":"equals"}},{"id":"7b1c8240-0ddd-438c-9862-4788fbd0cf6a","leftValue":"={{ $json.error.status }}","rightValue":"400","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[192,144],"id":"7fec2af4-0bb8-41af-abd7-d9bdde746059","name":"If2"},{"parameters":{"workflowId":{"__rl":true,"value":"N0Mpj3nRD1QnF7VH","mode":"list","cachedResultUrl":"/workflow/N0Mpj3nRD1QnF7VH","cachedResultName":"WF_ATUALIZA_TOKEN_SGA"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":["base"],"schema":[{"id":"base","displayName":"base","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[400,128],"id":"57710d76-176d-4e8a-a096-f2757f550392","name":"Execute Workflow1","executeOnce":true},{"parameters":{"operation":"get","tableId":"corDominio","filters":{"conditions":[{"keyName":"idDominio","keyValue":"domTokenSGA"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-288,144],"id":"75006874-412f-4893-b0a9-279d931145a8","name":"buscaTokenBD","credentials":{"supabaseApi":{"id":"S5lx7Z0EUntC6pYv","name":"Cotacao"}}},{"parameters":{"path":"atualizar_pessoa_associado","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-928,144],"id":"fb5008b8-c396-4fc0-bc0a-7d63502b587e","name":"Webhook","webhookId":"f6acbb5a-de26-410e-ba0a-3294bf61e236","executeOnce":true},{"parameters":{"rule":{"interval":[{"triggerAtHour":15,"triggerAtMinute":25}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-928,336],"id":"7695fbf0-26ed-43e0-bd41-fdbc067571a1","name":"Schedule Trigger","executeOnce":true,"disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"4f98bfdb-bf33-4568-93cd-17caa7af1eac","name":"quantidadePagina","value":3000,"type":"number"},{"id":"7da3ae77-c98b-4e88-acc2-764b9430c6bc","name":"pagina","value":"={{ $('loopPaginas').item.json.pagina.counter }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[624,352],"id":"3958b0e2-87d6-45c4-8f2d-c97af77d0f2b","name":"dadosPaginas","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"3c920d75-aaea-46f0-b73c-3590de62ebd0","leftValue":"={{ $json.error.status }}","rightValue":401,"operator":{"type":"number","operation":"equals"}},{"id":"54d76463-a28d-40bb-88fb-0ca340b6da0a","leftValue":"={{ $json.error.status }}","rightValue":403,"operator":{"type":"number","operation":"equals"}},{"id":"7b1c8240-0ddd-438c-9862-4788fbd0cf6a","leftValue":"={{ $json.error.status }}","rightValue":"400","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-288,736],"id":"0e0844b2-900b-4ad1-8d35-68037a0c2574","name":"If3"},{"parameters":{"errorMessage":"API BLOQUEADA"},"type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[-48,544],"id":"f1a3e739-5d2e-45e0-afc1-40957f62b8c2","name":"Stop and Error"},{"parameters":{"assignments":{"assignments":[{"id":"a5ba2546-bb0c-4057-ae8e-27c8d8df705e","name":"dtVencimentoInicial","value":"={{ \n  (() => {\n    const now = new Date();\n    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);\n    const dd = String(firstDay.getDate()).padStart(2, '0');\n    const mm = String(firstDay.getMonth() + 1).padStart(2, '0');\n    const yyyy = firstDay.getFullYear();\n    return `${dd}/${mm}/${yyyy}`;\n  })()\n}}","type":"string"},{"id":"b22f66c6-314b-43d6-a3de-3cd8d2aef75a","name":"dtVencimentoFinal","value":"={{ \n  (() => {\n    const now = new Date();\n    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n    const dd = String(lastDay.getDate()).padStart(2, '0');\n    const mm = String(lastDay.getMonth() + 1).padStart(2, '0');\n    const yyyy = lastDay.getFullYear();\n    return `${dd}/${mm}/${yyyy}`;\n  })()\n}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-528,144],"id":"bf5ff5be-4584-48c5-9ba2-e1abda0f94ee","name":"dadosDatas"},{"parameters":{"assignments":{"assignments":[{"id":"22ea84ea-02d0-461b-805e-604a7ae11814","name":"totpaginas","value":"={{ Array.from({length: $('dadosAPI').item.json.numero_paginas}, (_, i) => ({\"counter\": i})) }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-48,352],"id":"30ccd0f2-5776-477c-b6d2-ec10a92ba75d","name":"dadosLoop","notes":"{{ ('0' + 1).slice(-2) + '/' + ('0' + (new Date().getMonth() + 1)).slice(-2) + '/' + new Date().getFullYear() }}\n\n{{ ('0' + new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate()).slice(-2) + '/' + ('0' + (new Date().getMonth() + 1)).slice(-2) + '/' + new Date().getFullYear() }}"},{"parameters":{"assignments":{"assignments":[{"id":"22ea84ea-02d0-461b-805e-604a7ae11814","name":"numero_paginas","value":"={{ $('buscaQuantPaginas').item.json.body.numero_paginas }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-288,352],"id":"cd3c3171-ef47-4d50-99b2-aee2fea1efd3","name":"dadosAPI","notes":"{{ ('0' + 1).slice(-2) + '/' + ('0' + (new Date().getMonth() + 1)).slice(-2) + '/' + new Date().getFullYear() }}\n\n{{ ('0' + new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate()).slice(-2) + '/' + ('0' + (new Date().getMonth() + 1)).slice(-2) + '/' + new Date().getFullYear() }}"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[400,352],"id":"1940d29f-fd8e-4c31-815a-b6ec53b466f6","name":"loopPaginas"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[192,560],"id":"fe015147-88cb-4e6b-a7a7-8174e74b04c5","name":"Aggregate","executeOnce":true},{"parameters":{"errorMessage":"EXECUTADO"},"type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[624,128],"id":"e06729da-a8c2-40c4-9980-9c3e3d0cdf45","name":"Stop and Error1"},{"parameters":{"fieldToSplitOut":"totpaginas","options":{"destinationFieldName":"pagina"}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[192,352],"id":"c8b78ae4-564d-49c2-b559-9a81ecb2ea00","name":"splitPaginas","alwaysOutputData":true},{"parameters":{"method":"POST","url":"=https://api.hinova.com.br/api/sga/v2/listar/associado","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"={{ $('buscaTokenBD').item.json['descricaoDominio'] }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"codigo_situacao\": \"1\",\n  \"quantidade_por_pagina\": 3000,\n  \"inicio_paginacao\": 0\n}\n","options":{"response":{"response":{"fullResponse":true}},"timeout":1000000}},"id":"da8cd794-ebdf-4da8-9a98-51c2d45b090a","name":"buscaQuantPaginas","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-48,144],"continueOnFail":true},{"parameters":{"method":"POST","url":"=https://api.hinova.com.br/api/sga/v2/listar/associado","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"={{ $('buscaTokenBD').item.json['descricaoDominio'] }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"codigo_situacao\": \"1\",\n  \"quantidade_por_pagina\": {{ $('dadosPaginas').item.json.quantidadePagina }},\n  \"inicio_paginacao\": {{ $('loopPaginas').item.json.pagina.counter }}\n}\n","options":{"response":{"response":{"fullResponse":true}},"timeout":1000000}},"id":"defa19f1-3af2-42dc-bc7a-42471a57c3ae","name":"buscaAssociados","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-288,544],"continueOnFail":true},{"parameters":{"fieldToSplitOut":"body.associados","options":{"destinationFieldName":"associados"}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-48,736],"id":"947167f4-16c0-425c-9a76-3413124bd14c","name":"splitAssociados","alwaysOutputData":true},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[208,736],"id":"733c091b-181a-4e2f-98a8-aba1d4aa374a","name":"loop"},{"parameters":{"operation":"executeQuery","query":"-- üß© 1Ô∏è‚É£ Cria ou atualiza o registro na tabela cor_pessoa\nINSERT INTO public.cor_pessoa (\n  nome_pessoa,\n  cpf_cnpj_pessoa,\n  dom_tpo_pessoa,\n  telefone_pessoa,\n  whatsapp_pessoa,\n  celular_pessoa,\n  tel_recados_pessoa,\n  tel_comercial_pessoa,\n  email_pessoa,\n  dom_sexo,\n  cod_beneficiario_sga\n)\nVALUES (\n  '{{ $(\"loop\").item.json.associados.nome }}',\n  '{{ $(\"loop\").item.json.associados.cpf }}',\n  '{{ $(\"loop\").item.json.associados.tipo_pessoa }}',\n  '{{ $(\"loop\").item.json.associados.ddd }}{{ $(\"loop\").item.json.associados.telefone }}',\n  '{{ $(\"loop\").item.json.associados.ddd }}{{ $(\"loop\").item.json.associados.telefone_celular }}',\n  '{{ $(\"loop\").item.json.associados.ddd }}{{ $(\"loop\").item.json.associados.telefone_celular }}',\n  '', -- tel_recados_pessoa\n  '{{ $(\"loop\").item.json.associados.ddd_comercial }}{{ $(\"loop\").item.json.associados.telefone_comercial }}',\n  '{{ $(\"loop\").item.json.associados.email }}',\n  '{{ $(\"loop\").item.json.associados.sexo }}',\n  '{{ $(\"loop\").item.json.associados.codigo_associado }}'\n)\nON CONFLICT (cpf_cnpj_pessoa)\nDO UPDATE SET\n  nome_pessoa = EXCLUDED.nome_pessoa,\n  dom_tpo_pessoa = EXCLUDED.dom_tpo_pessoa,\n  telefone_pessoa = EXCLUDED.telefone_pessoa,\n  whatsapp_pessoa = EXCLUDED.whatsapp_pessoa,\n  celular_pessoa = EXCLUDED.celular_pessoa,\n  tel_comercial_pessoa = EXCLUDED.tel_comercial_pessoa,\n  email_pessoa = EXCLUDED.email_pessoa,\n  dom_sexo = EXCLUDED.dom_sexo,\n  cod_beneficiario_sga = EXCLUDED.cod_beneficiario_sga\nRETURNING id_pessoa;\n\n-- üß© 2Ô∏è‚É£ Cria ou atualiza o registro em cor_associado com o id_pessoa retornado\nINSERT INTO public.cor_associado (\n  id_pessoa,\n  id_empresa,\n  id_indicador,\n  dom_cat_associado,\n  dom_sit_associado\n)\nSELECT\n  id_pessoa,\n  NULL,\n  NULL,\n  'Associado',\n  'Ativo'\nFROM public.cor_pessoa\nWHERE cpf_cnpj_pessoa = '{{ $(\"loop\").item.json.associados.cpf }}'\nON CONFLICT (id_pessoa)\nDO UPDATE SET\n  dom_cat_associado = 'Associado',\n  dom_sit_associado = 'Ativo';\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[432,736],"id":"d32903e4-4772-4bbf-953f-45a71016ab74","name":"gravaAssociadoPessoa","executeOnce":true,"alwaysOutputData":true,"credentials":{"postgres":{"id":"vTHBosgrkOv6kRhi","name":"top-brasil-app-integracao"}},"onError":"continueRegularOutput"}],"connections":{"When clicking ‚ÄòExecute workflow‚Äô":{"main":[[{"node":"dadosDatas","type":"main","index":0}]]},"If2":{"main":[[{"node":"Execute Workflow1","type":"main","index":0}],[{"node":"dadosAPI","type":"main","index":0}]]},"Execute Workflow1":{"main":[[{"node":"buscaTokenBD","type":"main","index":0}]]},"buscaTokenBD":{"main":[[{"node":"buscaQuantPaginas","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"dadosDatas","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"dadosDatas","type":"main","index":0}]]},"dadosPaginas":{"main":[[{"node":"buscaAssociados","type":"main","index":0}]]},"If3":{"main":[[{"node":"Stop and Error","type":"main","index":0}],[{"node":"splitAssociados","type":"main","index":0}]]},"dadosDatas":{"main":[[{"node":"buscaTokenBD","type":"main","index":0}]]},"dadosLoop":{"main":[[{"node":"splitPaginas","type":"main","index":0}]]},"dadosAPI":{"main":[[{"node":"dadosLoop","type":"main","index":0}]]},"loopPaginas":{"main":[[{"node":"Stop and Error1","type":"main","index":0}],[{"node":"dadosPaginas","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"loopPaginas","type":"main","index":0}]]},"splitPaginas":{"main":[[{"node":"loopPaginas","type":"main","index":0}]]},"buscaQuantPaginas":{"main":[[{"node":"If2","type":"main","index":0}]]},"buscaAssociados":{"main":[[{"node":"If3","type":"main","index":0}]]},"splitAssociados":{"main":[[{"node":"loop","type":"main","index":0}]]},"loop":{"main":[[{"node":"Aggregate","type":"main","index":0}],[{"node":"gravaAssociadoPessoa","type":"main","index":0}]]},"gravaAssociadoPessoa":{"main":[[{"node":"loop","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataErrorExecution":"all","saveDataSuccessExecution":"all","saveExecutionProgress":true,"saveManualExecutions":true,"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"TfwD6eX8vHLcjYJt"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Schedule Trigger1":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"a7bcea90-c867-494f-8664-2dc73a5ba3c5","triggerCount":1,"shared":[{"createdAt":"2025-11-03T18:39:21.592Z","updatedAt":"2025-11-03T18:39:21.592Z","role":"workflow:owner","workflowId":"SrkGtBaU5fnafDvd","projectId":"Q1ZOyZgW3upjWPqV"}],"tags":[{"createdAt":"2025-09-24T20:09:10.216Z","updatedAt":"2025-09-24T20:09:10.216Z","id":"unxeE4bOTKE0sCc3","name":"BI"},{"createdAt":"2025-10-31T20:57:24.413Z","updatedAt":"2025-10-31T20:57:24.413Z","id":"XBzzNcD65NDClpM2","name":"20:00"}]}