{"createdAt":"2025-12-09T18:16:51.605Z","updatedAt":"2025-12-09T18:39:29.646Z","id":"aSmDNw4A1UZWUrtX","name":"TMR_CATEGORIA_VEIC_SGA_TOP","active":false,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-544,-208],"id":"fc06b742-e695-444e-a2a9-904f24cb8715","name":"When clicking ‘Execute workflow’"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-320,-208],"id":"85020a6e-02dd-4ef6-8411-c68b2a1b8648","name":"No Operation, do nothing"},{"parameters":{"operation":"get","tableId":"corDominio","filters":{"conditions":[{"keyName":"idDominio","keyValue":"domTokenSGABoletos"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-96,0],"id":"06f4a00f-5cef-4579-9c66-7d8d9d528375","name":"buscaToken","credentials":{"supabaseApi":{"id":"S5lx7Z0EUntC6pYv","name":"Cotacao"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"3c920d75-aaea-46f0-b73c-3590de62ebd0","leftValue":"={{ $('buscaDadosSGA').item.json.error.status }}","rightValue":401,"operator":{"type":"number","operation":"equals"}},{"id":"54d76463-a28d-40bb-88fb-0ca340b6da0a","leftValue":"={{ $('buscaDadosSGA').item.json.error.status }}","rightValue":403,"operator":{"type":"number","operation":"equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[352,0],"id":"579f740a-57e5-4e16-9e19-c69c69d06f98","name":"If1"},{"parameters":{"workflowId":{"__rl":true,"value":"N0Mpj3nRD1QnF7VH","mode":"list","cachedResultName":"WF_ATUALIZA_TOKEN_SGA"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":["base"],"schema":[{"id":"base","displayName":"base","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[576,-16],"id":"58fd332d-ee31-4fd2-aad5-33eef761f000","name":"Execute Workflow","executeOnce":true},{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"30 20 * * *"}]}},"id":"fc93851b-45a8-4f4f-904a-b6c5e6704362","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[-544,-16]},{"parameters":{"path":"7d12832c-96e0-4077-837f-f75da5bc36d7","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-544,-400],"id":"1f09e142-471c-4e52-ac2f-e80ca3a93234","name":"Webhook","webhookId":"7d12832c-96e0-4077-837f-f75da5bc36d7"},{"parameters":{"operation":"send","phoneNumberId":"864975313369366","recipientPhoneNumber":"=+5531992240123","textBody":"=Atualização Depreciação - Finalizado \n{{ 'Inseridas: ' + $json.total_inseridos + '\\n' +\n   'Atualizadas: ' + $json.total_atualizados + '\\n' +\n   'Ativadas: ' + $json.total_ativos + '\\n' +\n   'Inativadas: ' + $json.total_inativos }}","additionalFields":{}},"type":"n8n-nodes-base.whatsApp","typeVersion":1,"position":[352,-224],"id":"0ea9ade1-4536-4a51-986f-ef45eec62bb9","name":"Send message1","webhookId":"92c7a8de-c5be-4379-9694-714c5b857890","credentials":{"whatsAppApi":{"id":"uhkZVEvkMfFDnJdn","name":"BM TOP WABA 1659637782089115 3195929809"}}},{"parameters":{"url":"=https://api.hinova.com.br/api/sga/v2/listar/categoria-veiculo/{{$('buscaDadosERPTop').item.json.seq_dominio}}/todos","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"={{ $('buscaToken').item.json['descricaoDominio'] }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"pagina\": \"0\",\n  \"situacao\": \"todos\"\n}","options":{"response":{"response":{"fullResponse":true}}}},"id":"9ee26209-ccf5-4a7f-869d-c66f75bb9bac","name":"buscaDadosSGA","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[128,0],"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"WITH entrada AS (\n    -- Normaliza o JSON para sempre virar um array\n    SELECT\n        CASE\n            WHEN jsonb_typeof($1::jsonb) = 'array' THEN $1::jsonb\n            ELSE jsonb_build_array($1::jsonb)\n        END AS js\n),\n\n-- Extrai todos os arrays possíveis (body, data, resultados, ou array direto)\narrays AS (\n    SELECT\n        CASE\n            WHEN jsonb_typeof(elem->'body') = 'array' THEN elem->'body'\n            WHEN jsonb_typeof(elem->'data') = 'array' THEN elem->'data'\n            WHEN jsonb_typeof(elem) = 'array'          THEN elem\n            ELSE jsonb_build_array(elem)\n        END AS arr\n    FROM entrada, jsonb_array_elements(entrada.js) AS elem\n),\n\n-- Explode os arrays finais em itens individuais\nraw AS (\n    SELECT jsonb_array_elements(arr) AS elem\n    FROM arrays\n),\n\n-- Normaliza os campos esperados\nnorm AS (\n    SELECT\n        'DOM_CAT_VEICULO' AS id_dominio,\n\n        elem->>'descricao_categoria'     AS val_dominio,\n        COALESCE(\n            NULLIF(elem->>'descricao_categoria',''),\n            NULLIF(elem->>'descricao',''),\n            NULLIF(elem->>'desc_categoria','')\n        ) AS dsc_val_dominio,\n  \n        elem->>'situacao'      AS sit_val_dominio,\n\n        COALESCE(\n            NULLIF(elem->>'codigo_categoria',''),\n            NULLIF(elem->>'codigo','')\n        )::int2 AS seq_dominio\n\n    FROM raw\n),\n\n-- Filtra registros válidos\nvalidos AS (\n    SELECT *\n    FROM norm\n    WHERE val_dominio IS NOT NULL\n      AND seq_dominio IS NOT NULL\n),\n\n-- UPSERT (inserção ou atualização)\nupsert AS (\n    INSERT INTO cor_val_dominio (\n        id_dominio,\n        val_dominio,\n        dsc_val_dominio,\n        sit_val_dominio,\n        seq_dominio\n    )\n    SELECT *\n    FROM validos\n    ON CONFLICT (id_dominio, val_dominio)\n    DO UPDATE SET\n        dsc_val_dominio = EXCLUDED.dsc_val_dominio,\n        sit_val_dominio = EXCLUDED.sit_val_dominio,\n        seq_dominio     = EXCLUDED.seq_dominio\n    RETURNING\n        (xmax = 0) AS inserted,\n        (xmax <> 0) AS updated,\n        sit_val_dominio\n),\n\n-- Estatísticas finais\nstats AS (\n    SELECT\n        COUNT(*) FILTER (WHERE inserted) AS total_inseridos,\n        COUNT(*) FILTER (WHERE updated)  AS total_atualizados,\n        COUNT(*) FILTER (WHERE sit_val_dominio = 'ATIVO')   AS total_ativos,\n        COUNT(*) FILTER (WHERE sit_val_dominio = 'INATIVO') AS total_inativos\n    FROM upsert\n)\n\nSELECT * FROM stats;\n","options":{"queryReplacement":"={{ JSON.stringify($('buscaDadosSGA').item.json.body || []) }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[576,224],"id":"9eba9e04-1c27-4975-9a27-6eeb44528fcd","name":"gravaDadosERPTop","executeOnce":true,"alwaysOutputData":false,"credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"select *\nfrom public.cor_val_dominio \nwhere id_dominio = 'DOM_TPO_VEICULO'\norder by 4","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-96,-208],"id":"5b0c935a-d22f-4c64-8389-5e716ff0b31f","name":"buscaDadosERPTop","executeOnce":true,"alwaysOutputData":false,"credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}},"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[112,-208],"id":"de636c13-e81a-4c6a-b34f-024c47341f27","name":"loop"}],"connections":{"When clicking ‘Execute workflow’":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"No Operation, do nothing":{"main":[[{"node":"buscaDadosERPTop","type":"main","index":0}]]},"buscaToken":{"main":[[{"node":"buscaDadosSGA","type":"main","index":0}]]},"If1":{"main":[[{"node":"Execute Workflow","type":"main","index":0}],[{"node":"gravaDadosERPTop","type":"main","index":0}]]},"Execute Workflow":{"main":[[{"node":"buscaToken","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"buscaDadosSGA":{"main":[[{"node":"If1","type":"main","index":0}]]},"gravaDadosERPTop":{"main":[[{"node":"loop","type":"main","index":0}]]},"buscaDadosERPTop":{"main":[[{"node":"loop","type":"main","index":0}]]},"loop":{"main":[[{"node":"Send message1","type":"main","index":0}],[{"node":"buscaToken","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"fed790f7-3042-429e-a6ff-693ec448a88f","triggerCount":0,"shared":[{"createdAt":"2025-12-09T18:16:51.605Z","updatedAt":"2025-12-09T18:16:51.605Z","role":"workflow:owner","workflowId":"aSmDNw4A1UZWUrtX","projectId":"Q1ZOyZgW3upjWPqV"}],"tags":[]}