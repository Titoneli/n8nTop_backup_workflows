{"createdAt":"2025-12-12T14:53:29.029Z","updatedAt":"2025-12-12T16:12:40.695Z","id":"dHJLGG2RQun9vk9d","name":"SUB_POPULA_ERP_COR_VEICULOS_PLACA","active":false,"isArchived":false,"nodes":[{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"3c920d75-aaea-46f0-b73c-3590de62ebd0","leftValue":"={{ $json.error.status }}","rightValue":401,"operator":{"type":"number","operation":"equals"}},{"id":"54d76463-a28d-40bb-88fb-0ca340b6da0a","leftValue":"={{ $json.error.status }}","rightValue":403,"operator":{"type":"number","operation":"equals"}},{"id":"7b1c8240-0ddd-438c-9862-4788fbd0cf6a","leftValue":"={{ $json.error.status }}","rightValue":"400","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-288,736],"id":"f37ce3f6-e86a-490e-9a71-ae3313f6e084","name":"If3"},{"parameters":{"errorMessage":"API BLOQUEADA"},"type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[-48,544],"id":"751ae1b8-e7bb-4303-85ae-98ae57887a5b","name":"Stop and Error"},{"parameters":{"url":"=https://api.hinova.com.br/api/sga/v2/veiculo/buscar/{{ $('Execute').item.json.placa }}/placa","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"={{ $('Execute').item.json['token'] }}"}]},"options":{"response":{"response":{"fullResponse":true}},"timeout":1000000}},"id":"baa6a08c-851e-4bee-9bc8-afb759e1780e","name":"buscaDados","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-288,544],"alwaysOutputData":true,"continueOnFail":true},{"parameters":{"operation":"executeQuery","query":"WITH \n-- ============================================================\n-- 0) REGISTRO DA EXECUÇÃO\n-- ============================================================\nrun AS (\n    INSERT INTO import_run_veiculos (run_ts)\n    VALUES (now())\n    RETURNING id_run, run_ts\n),\n\n-- ============================================================\n-- 1) ENTRADA DO JSON (já é um array de veículos)\n-- ============================================================\nentrada AS (\n    SELECT \n        CASE \n            WHEN jsonb_typeof($1::jsonb) = 'array' THEN $1::jsonb\n            ELSE jsonb_build_array($1::jsonb)\n        END AS js\n),\n\nraw AS (\n    SELECT jsonb_array_elements(js) AS veiculo\n    FROM entrada\n),\n\n-- ============================================================\n-- 2) NORMALIZAÇÃO DOS CAMPOS (MAIÚSCULAS EM TEXTOS)\n-- ============================================================\nnorm AS (\n    SELECT\n        NULLIF(veiculo->>'codigo_veiculo','')::bigint AS id_veiculo,\n        NULLIF(veiculo->>'codigo_associado','')::bigint AS cod_associado,\n        NULLIF(veiculo->>'codigo_modelo','')::bigint AS id_modelo,\n\n        UPPER(veiculo->>'nome') AS nome_proprietario,\n        UPPER(veiculo->>'cpf')  AS cpf_cnpj,\n\n        UPPER(veiculo->>'ano_modelo')      AS ano_modelo,\n        UPPER(veiculo->>'ano_fabricacao')  AS ano_fabricacao,\n\n        UPPER(veiculo->>'placa')   AS num_placa,\n        UPPER(veiculo->>'renavam') AS num_renavam,\n        UPPER(veiculo->>'chassi')  AS num_chassi,\n\n        (veiculo->>'codigo_tipo_veiculo')::int       AS cod_tpo_veic,\n        (veiculo->>'codigo_classificacao')::int      AS cod_classificacao_veic,\n        (veiculo->>'codigo_combustivel')::int        AS cod_combustivel,\n        (veiculo->>'codigo_cor')::int                AS cod_cor,\n        (veiculo->>'codigo_situacao')::int           AS cod_sit,\n\n        NULLIF(veiculo->>'data_contrato','')::timestamp        AS dth_ini_vigencia,\n        NULLIF(veiculo->>'data_contrato_final','')::timestamp  AS dth_fim_vigencia,\n        NULLIF(veiculo->>'data_cadastro','')::timestamp        AS dth_cad_veiculo,\n        NULLIF(veiculo->>'data_reativacao','')::timestamp      AS dth_atv_veiculo,\n\n        UPPER(veiculo->>'codigo_fipe') AS cod_fipe,\n        NULLIF(veiculo->>'valor_fipe','')::numeric AS valor_fipe,\n        NULLIF(veiculo->>'valor_fipe_protegido','')::numeric AS valor_ajustado,\n\n        -- NOVOS CAMPOS SGA\n        NULLIF(veiculo->>'codigo_regional','')::bigint     AS sga_codigo_regional,\n        NULLIF(veiculo->>'codigo_cooperativa','')::bigint  AS sga_codigo_cooperativa,\n        NULLIF(veiculo->>'codigo_voluntario','')::bigint   AS sga_codigo_voluntario,\n\n        veiculo AS payload\n    FROM raw\n),\n\n-- ============================================================\n-- 3) LOCALIZA A PESSOA DO ASSOCIADO\n-- ============================================================\njoin_associado AS (\n    SELECT n.*, a.id_pessoa\n    FROM norm n\n    LEFT JOIN cor_associado a\n           ON a.cod_associado = n.cod_associado\n),\n\n-- ============================================================\n-- 4) LOCALIZA O COLABORADOR PELO codigo_voluntario\n-- ============================================================\njoin_colaborador AS (\n    SELECT j.*, c.id_colaborador\n    FROM join_associado j\n    LEFT JOIN cor_colaborador c\n           ON c.cod_colaborador = j.sga_codigo_voluntario::text\n),\n\n-- ============================================================\n-- 5) RESOLVE DOMÍNIOS\n-- ============================================================\nresolve_dom AS (\n    SELECT \n        jc.*,\n        tpo.val_dominio  AS dom_tpo_veic,\n        cat.val_dominio  AS dom_cat_veic,\n        comb.val_dominio AS dom_combustivel,\n        cor.val_dominio  AS dom_cor,\n        sit.val_dominio  AS dom_sit_veic\n    FROM join_colaborador jc\n    LEFT JOIN cor_val_dominio tpo\n           ON tpo.id_dominio = 'DOM_TPO_VEICULO'\n          AND tpo.seq_dominio = jc.cod_tpo_veic\n    LEFT JOIN cor_val_dominio cat\n           ON cat.id_dominio = 'DOM_CLASSIFICACAO_VEICULO'\n          AND cat.seq_dominio = jc.cod_classificacao_veic\n    LEFT JOIN cor_val_dominio comb\n           ON comb.id_dominio = 'DOM_COMBUSTIVEL'\n          AND comb.seq_dominio = jc.cod_combustivel\n    LEFT JOIN cor_val_dominio cor\n           ON cor.id_dominio = 'DOM_COR'\n          AND cor.seq_dominio = jc.cod_cor\n    LEFT JOIN cor_val_dominio sit\n           ON sit.id_dominio = 'DOM_SIT_VEICULO'\n          AND sit.seq_dominio = jc.cod_sit\n),\n\n-- ============================================================\n-- 6) INCONSISTÊNCIAS\n-- ============================================================\ninvalids AS (\n    SELECT\n        r.*,\n        CASE\n            WHEN r.cod_combustivel IS NOT NULL AND r.dom_combustivel IS NULL THEN 'DOM_COMBUSTIVEL not found seq='||r.cod_combustivel\n            WHEN r.cod_cor IS NOT NULL AND r.dom_cor IS NULL THEN 'DOM_COR not found seq='||r.cod_cor\n            WHEN r.cod_tpo_veic IS NOT NULL AND r.dom_tpo_veic IS NULL THEN 'DOM_TPO_VEICULO not found seq='||r.cod_tpo_veic\n            WHEN r.cod_classificacao_veic IS NOT NULL AND r.dom_cat_veic IS NULL THEN 'DOM_CLASSIFICACAO_VEICULO not found seq='||r.cod_classificacao_veic\n            WHEN r.cod_sit IS NOT NULL AND r.dom_sit_veic IS NULL THEN 'DOM_SIT_VEICULO not found seq='||r.cod_sit\n            ELSE NULL\n        END AS issue\n    FROM resolve_dom r\n    WHERE\n        (r.cod_combustivel IS NOT NULL AND r.dom_combustivel IS NULL)\n     OR (r.cod_cor IS NOT NULL AND r.dom_cor IS NULL)\n     OR (r.cod_tpo_veic IS NOT NULL AND r.dom_tpo_veic IS NULL)\n     OR (r.cod_classificacao_veic IS NOT NULL AND r.dom_cat_veic IS NULL)\n     OR (r.cod_sit IS NOT NULL AND r.dom_sit_veic IS NULL)\n),\n\nlog_insert AS (\n    INSERT INTO import_log_veiculos (run_ts, id_veiculo, payload, issue)\n    SELECT (SELECT run_ts FROM run), id_veiculo, payload, issue\n    FROM invalids\n),\n\n-- ============================================================\n-- 7) SOMENTE REGISTROS VÁLIDOS\n-- ============================================================\nvalid AS (\n    SELECT *\n    FROM resolve_dom r\n    WHERE NOT EXISTS (SELECT 1 FROM invalids i WHERE i.id_veiculo = r.id_veiculo)\n),\n\n-- ============================================================\n-- 8) UPSERT FINAL EM cor_veiculo\n-- ============================================================\nupsert AS (\n    INSERT INTO cor_veiculo (\n        ID_VEICULO, ID_PESSOA, ID_MODELO,\n        NOME_PROPRIETARIO, CPF_CNPJ,\n        ANO_MODELO, ANO_FABRICACAO, NUM_PLACA, NUM_RENAVAM, NUM_CHASSI,\n        DOM_TPO_VEICULO, DOM_TPO_COMBUSTIVEL,\n        DOM_COR, DOM_SIT_VEICULO,\n        DTH_INI_VIGENCIA, DTH_FIM_VIGENCIA, DTH_CAD_VEICULO, DTH_ATV_VEICULO,\n        COD_FIPE, VALOR_FIPE, VALOR_AJUSTADO,\n\n        -- NOVOS CAMPOS\n        ID_COLABORADOR,\n        SGA_CODIGO_REGIONAL,\n        SGA_CODIGO_COOPERATIVA,\n        SGA_CODIGO_VOLUNTARIO\n    )\n    SELECT\n        id_veiculo,\n        id_pessoa,\n        id_modelo,\n        nome_proprietario,\n        cpf_cnpj,\n        ano_modelo,\n        ano_fabricacao,\n        num_placa,\n        num_renavam,\n        num_chassi,\n        dom_tpo_veic,\n        dom_combustivel,\n        dom_cor,\n        dom_sit_veic,\n        dth_ini_vigencia,\n        dth_fim_vigencia,\n        dth_cad_veiculo,\n        dth_atv_veiculo,\n        cod_fipe,\n        valor_fipe,\n        valor_ajustado,\n\n        -- CAMPOS NOVOS\n        id_colaborador,\n        sga_codigo_regional,\n        sga_codigo_cooperativa,\n        sga_codigo_voluntario\n    FROM valid\n    ON CONFLICT (ID_VEICULO)\n    DO UPDATE SET\n        ID_PESSOA = EXCLUDED.ID_PESSOA,\n        ID_MODELO = EXCLUDED.ID_MODELO,\n        NOME_PROPRIETARIO = EXCLUDED.NOME_PROPRIETARIO,\n        CPF_CNPJ = EXCLUDED.CPF_CNPJ,\n        ANO_MODELO = EXCLUDED.ANO_MODELO,\n        ANO_FABRICACAO = EXCLUDED.ANO_FABRICACAO,\n        NUM_PLACA = EXCLUDED.NUM_PLACA,\n        NUM_RENAVAM = EXCLUDED.NUM_RENAVAM,\n        NUM_CHASSI = EXCLUDED.NUM_CHASSI,\n        DOM_TPO_VEICULO = EXCLUDED.DOM_TPO_VEICULO,\n        DOM_TPO_COMBUSTIVEL = EXCLUDED.DOM_TPO_COMBUSTIVEL,\n        DOM_COR = EXCLUDED.DOM_COR,\n        DOM_SIT_VEICULO = EXCLUDED.DOM_SIT_VEICULO,\n        VALOR_FIPE = EXCLUDED.VALOR_FIPE,\n        VALOR_AJUSTADO = EXCLUDED.VALOR_AJUSTADO,\n        ID_COLABORADOR = EXCLUDED.ID_COLABORADOR,\n        SGA_CODIGO_REGIONAL = EXCLUDED.SGA_CODIGO_REGIONAL,\n        SGA_CODIGO_COOPERATIVA = EXCLUDED.SGA_CODIGO_COOPERATIVA,\n        SGA_CODIGO_VOLUNTARIO = EXCLUDED.SGA_CODIGO_VOLUNTARIO,\n        DTH_ATV_VEICULO = EXCLUDED.DTH_ATV_VEICULO\n    RETURNING (xmax = 0) AS inserted, (xmax <> 0) AS updated\n),\n\n-- ============================================================\n-- 9) ESTATÍSTICAS DO PROCESSO\n-- ============================================================\nstats AS (\n    SELECT\n        COALESCE(SUM(CASE WHEN inserted THEN 1 ELSE 0 END),0) AS total_inseridos,\n        COALESCE(SUM(CASE WHEN updated THEN 1 ELSE 0 END),0) AS total_atualizados,\n        (SELECT COUNT(*) FROM invalids) AS total_inconsistentes\n    FROM upsert\n)\n\nSELECT \n    total_inseridos,\n    total_atualizados,\n    total_inconsistentes,\n    (\n        SELECT jsonb_agg(jsonb_build_object(\n            'id_veiculo', id_veiculo,\n            'issue', issue,\n            'payload', payload\n        ))\n        FROM invalids LIMIT 50\n    ) AS sample_inconsistencias\nFROM stats;","options":{"queryReplacement":"={{ JSON.stringify($('buscaDados').item.json.body || []) }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-48,736],"id":"bd984b17-d00a-4344-9fa2-49cef96f5ba9","name":"gravaDados","executeOnce":true,"alwaysOutputData":false,"credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}},"onError":"continueRegularOutput"},{"parameters":{"workflowInputs":{"values":[{"name":"quantidadePagina","type":"number"},{"name":"pagina","type":"number"},{"name":"token"},{"name":"placa"},{"name":"codigo_veiculo"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-512,544],"id":"ef8a57f0-40b3-4ec3-9cd1-4648689f021f","name":"Execute"}],"connections":{"If3":{"main":[[{"node":"Stop and Error","type":"main","index":0}],[{"node":"gravaDados","type":"main","index":0}]]},"buscaDados":{"main":[[{"node":"If3","type":"main","index":0}]]},"gravaDados":{"main":[[]]},"Execute":{"main":[[{"node":"buscaDados","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataErrorExecution":"all","saveDataSuccessExecution":"all","saveExecutionProgress":true,"saveManualExecutions":true,"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"TfwD6eX8vHLcjYJt"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Schedule Trigger1":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"buscaDados":[{"json":{"body":[{"codigo_veiculo":"158388","codigo_depreciacao":"1","placa":"NHN4F59","chassi":"9BWDB09N29P008671","codigo_fipe":"005214-0","valor_fipe_protegido":"30072.00","porcentagem_fipe_protegido":0,"valor_fipe":30072,"valor_fixo":0,"pontos":0,"valor_adesao":0,"mes_final_carne":0,"mes_referente":"","participacao":0,"codigo_tipo_envio_boleto":"3","descricao_tipo_envio_boleto":"ENVIO POR E-MAIL E WHATSAPP","forma_pagamento_protecao":1,"ano_fabricacao":2008,"ano_modelo":2009,"data_reativacao":null,"codigo_classificacao":"1","renavam":"00974145149","quantidade_portas":0,"quantidade_passageiros":0,"cambio":"M","cilindrada":0,"numero_motor":"CCR702830","km":0,"codigo_regional":"2","codigo_cooperativa":"3","codigo_associado":"53879","codigo_tipo_veiculo":"1","codigo_externo":null,"codigo_cota":"2885","cota":"NEW VEÍCULOS LEVES - R$ 30.000,01 à R$ 35.000,00","codigo_categoria":"1","tipo":"VEICULOS LEVES","categoria":"NORMAL","codigo_marca":"58","marca":"VW - VOLKSWAGEN","codigo_modelo":"2950","modelo":"POLO SEDAN 1.6 MI TOTAL FLEX 8V 4P","codigo_combustivel":"1","codigo_cor":"6","codigo_grupo_produto":"4","nome":"JOAO MARCOS ROSA PEREIRA JUNIOR","rg":"20359213","cpf":"14887178697","telefone":"","ddd":"","telefone_celular":"9996-56041","ddd_celular":"37","telefone_celular_aux":"","ddd_celular_aux":"","telefone_comercial":"","ddd_comercial":"","email":"joaomarcosrosaferreira1067@gmail.com","logradouro":"AVENIDA SEBASTIÃO ELIAS","numero":"723","complemento":"CASA","bairro":"ANA CAROLINA","cidade":"NOVA SERRANA","estado":"MG","cep":"35527-134","codigo_situacao":"1","data_cadastro":"2025-12-12T00:00:00-0300","hora_cadastro":"12:37:03","data_contrato":"2025-12-12T00:00:00-0300","codigo_vencimeto":"5","boleto_fisico":"N","dia_vencimento":"20","descricao_situacao":"ATIVO","codigo_voluntario":"48","nome_voluntario":"DAVID FERNANDES DE AZEVEDO","cpf_voluntario":"14051972690","codigo_veiculo_vinculado":null,"codigo_veiculo_indicador":null,"placa_veiculo_indicador":null,"codigo_associado_indicador":null,"cpf_associado_indicador":null,"nome_associado_indicador":null,"codigo_tabela_avaliacao":"0","usuario_cadastro":"CRM","campos_opcionais":["sem campo opcional cadastrado"]}],"headers":{"date":"Fri, 12 Dec 2025 15:37:58 GMT","content-type":"application/json","content-length":"2197","connection":"close","server":"nginx/1.22.1"},"statusCode":200,"statusMessage":"OK"}}]},"versionId":"c8ecddf6-e44d-4b17-9454-6d734dd440c7","triggerCount":2,"shared":[{"createdAt":"2025-12-12T14:53:29.029Z","updatedAt":"2025-12-12T14:53:29.029Z","role":"workflow:owner","workflowId":"dHJLGG2RQun9vk9d","projectId":"Q1ZOyZgW3upjWPqV"}],"tags":[{"createdAt":"2025-09-24T20:09:10.216Z","updatedAt":"2025-09-24T20:09:10.216Z","id":"unxeE4bOTKE0sCc3","name":"BI"},{"createdAt":"2025-10-31T20:57:24.413Z","updatedAt":"2025-10-31T20:57:24.413Z","id":"XBzzNcD65NDClpM2","name":"20:00"}]}