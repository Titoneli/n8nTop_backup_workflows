{"createdAt":"2025-08-13T13:23:23.775Z","updatedAt":"2025-09-28T19:46:23.820Z","id":"KCnRnVUKZAdJz3fo","name":"TMR_MSG_ANIVERSARIANTES_CONSULTOR_TOP","active":true,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-960,-32],"id":"731d61e4-ff28-48fd-81bb-204cb91ae4fb","name":"When clicking â€˜Execute workflowâ€™"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-720,48],"id":"bcf8640a-a861-4a19-96a9-626ffb6383ae","name":"No Operation, do nothing"},{"parameters":{"operation":"get","tableId":"corDominio","filters":{"conditions":[{"keyName":"idDominio","keyValue":"domTokenSGA"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-480,48],"id":"57ae0bdc-032d-43e1-9b4d-3ef83a537947","name":"buscaToken","credentials":{"supabaseApi":{"id":"S5lx7Z0EUntC6pYv","name":"Cotacao"}}},{"parameters":{"assignments":{"assignments":[{"id":"065cba84-e646-41a9-b744-827715bcd905","name":"codigo_associado","value":"={{ $('loopAniversariantes').item.json.codigo_associado }}","type":"string"},{"id":"5aa88ee4-3d56-4506-a367-de03cdabceff","name":"codigo_situacao","value":"={{ $('loopAniversariantes').item.json.codigo_situacao }}","type":"string"},{"id":"c6cdb42b-5704-4f49-b27b-6f7e1b6a4d57","name":"nome","value":"={{ $('loopAniversariantes').item.json.nome.toLowerCase().replace(/\\b\\w/g, c => c.toUpperCase()) }}","type":"string"},{"id":"7693aff7-97c7-4f44-a50e-8dac859ec5cf","name":"telefone_celular","value":"={{ $('loopAniversariantes').item.json.telefone_celular }}","type":"string"},{"id":"65d649c4-5bc2-454a-8cea-b38993a5fabe","name":"mensagem","value":"={{\n'https://wa.me/55' + \n$json.telefone_celular.match( /\\d+/g ).join('') + \n'?text=' + encodeURIComponent(`OlÃ¡, ${$json.nome.toLowerCase().replace(/\\b\\w/g, c => c.toUpperCase())}, hoje Ã© um dia especial e nÃ£o poderÃ­amos deixar de lembrar! Desejamos muitas felicidades, saÃºde e sucesso. Conte sempre com a gente. TopBrasilðŸŽ‰`)\n}}\n\n","type":"string"},{"id":"a66717f2-a243-43ed-97e8-e4817ac169b7","name":"data_nascimento","value":"={{ $now.format('yyyy-MM-dd') }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-944,336],"id":"2ef4f181-f1a2-4f0d-a88f-5a969cea62ef","name":"dadosAniversariantes"},{"parameters":{"url":"=https://api.hinova.com.br/api/sga/v2/buscar/voluntario/{{$json.body[0].codigo_voluntario}}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"={{ $('buscaToken').item.json['descricaoDominio'] }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"id":"4178e952-b358-4b5e-9109-9cfd442bcc70","name":"buscaSGAConsultor","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-48,336],"continueOnFail":true},{"parameters":{"url":"=https://api.hinova.com.br/api/sga/v2/associado/aniversariante","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"={{ $('buscaToken').item.json['descricaoDominio'] }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"id":"28c27860-9ca6-4a36-b7cc-9ef3f81af9f4","name":"buscaSGAAniversariantes","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-272,48],"continueOnFail":true},{"parameters":{"url":"=https://tinyurl.com/api-create.php?url={{ $('dadosAniversariantes').item.json.mensagem }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[176,336],"id":"c29ae963-7d1b-4da9-ae08-7861d04e0739","name":"reduzURL","onError":"continueRegularOutput"},{"parameters":{"url":"=https://api.hinova.com.br/api/sga/v2/associado/buscar/{{ $('dadosAniversariantes').item.json.codigo_associado }}/codigo","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"={{ $('buscaToken').item.json['descricaoDominio'] }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"id":"7addb564-52f3-4202-9daf-4d5053ae3ff0","name":"buscaAssociado","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-720,336],"continueOnFail":true},{"parameters":{"assignments":{"assignments":[{"id":"065cba84-e646-41a9-b744-827715bcd905","name":"codigo_associado","value":"={{ $('loopAniversariantes').item.json.codigo_associado }}","type":"string"},{"id":"5aa88ee4-3d56-4506-a367-de03cdabceff","name":"codigo_situacao","value":"={{ $('loopAniversariantes').item.json.codigo_situacao }}","type":"string"},{"id":"c6cdb42b-5704-4f49-b27b-6f7e1b6a4d57","name":"nome","value":"={{ $('loopAniversariantes').item.json.nome.toLowerCase().replace(/\\b\\w/g, c => c.toUpperCase()) }}","type":"string"},{"id":"7693aff7-97c7-4f44-a50e-8dac859ec5cf","name":"telefone_celular","value":"={{ $('loopAniversariantes').item.json.telefone_celular }}","type":"string"},{"id":"65d649c4-5bc2-454a-8cea-b38993a5fabe","name":"mensagem","value":"={{ $('reduzURL').item.json.data }}","type":"string"},{"id":"a66717f2-a243-43ed-97e8-e4817ac169b7","name":"data_nascimento","value":"={{ $now.format('yyyy-MM-dd') }}","type":"string"},{"id":"00d06389-83c2-4240-a731-ab7cda3787cc","name":"codigo_voluntario","value":"={{ $('buscaAssociado').item.json.body.codigo_voluntario }}","type":"string"},{"id":"0f97e20b-c737-44ff-8b6c-a05ba6557625","name":"nome_voluntario","value":"={{ $('buscaSGAConsultor').item.json.body[0].nome }}","type":"string"},{"id":"63fcf5c1-b0aa-478c-a330-97459fa11558","name":"celular_voluntario","value":"={{ $('buscaSGAConsultor').item.json.body[0].celular }}","type":"string"},{"id":"7c4fd27b-fe6a-4d1a-871b-1607bed7fe31","name":"situacao_voluntario","value":"={{ $('buscaSGAConsultor').item.json.body[0].situacao }}","type":"string"},{"id":"e5199e29-6c34-4e29-8cfa-eefdc0913129","name":"telefone_voluntario","value":"={{ $('buscaSGAConsultor').item.json.body[0].telefone }}","type":"string"},{"id":"ab48feb0-aa19-4372-b8d1-84d3b6327894","name":"placa","value":"={{ $('buscaVeiculos').item.json.body[0].placa }}","type":"string"},{"id":"98981a00-5bcb-4035-90e2-a86c118ed091","name":"descricao_situacao","value":"={{ $('buscaVeiculos').item.json.body[0].descricao_situacao}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-944,544],"id":"1cfc479b-eed6-4dd2-a1d2-df7cd5996776","name":"dadosAssociado"},{"parameters":{"url":"=https://api.hinova.com.br/api/sga/v2/veiculo/buscar/{{$json.placa}}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"={{ $('buscaToken').item.json['descricaoDominio'] }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"id":"5d63c8f9-f1fe-4622-b669-ab15c0bd0faf","name":"buscaVeiculos","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-272,336],"continueOnFail":true},{"parameters":{"fieldToSplitOut":"body.veiculos","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-496,336],"id":"d2238031-7aef-4a71-a063-c8389f2929e8","name":"Split Out1"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-272,528],"id":"21d9720b-a481-447e-824e-17e792f70c40","name":"Aggregate2"},{"parameters":{"fieldToSplitOut":"body","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[176,144],"id":"a0df0a9b-475a-48b3-8ee4-557bcc289531","name":"loopAniversariantes"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"dddde1aa-d852-4eaa-abeb-eb6d88c4051f","leftValue":"={{ $('buscaVeiculos').item.json.body[0].descricao_situacao}}","rightValue":"ATIVO","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"76ac6a6b-e469-4baa-99b1-0ceef597e8b6","leftValue":"={{ $('dadosAssociado').item.json.telefone_voluntario}}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-720,544],"id":"717380e8-04fa-4066-ba84-7f0b2303990c","name":"If"},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"nome"},{"fieldToAggregate":"nome_voluntario"},{"fieldToAggregate":"telefone_voluntario"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[176,960],"id":"5853e41e-cc25-4f1b-9043-4e09bf6989a7","name":"Aggregate"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3c920d75-aaea-46f0-b73c-3590de62ebd0","leftValue":"={{ $('buscaSGAAniversariantes').item.json.error.status }}","rightValue":401,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-48,48],"id":"661c82c4-c8d9-478f-9bc9-055d3d8720b6","name":"If1"},{"parameters":{"workflowId":{"__rl":true,"value":"N0Mpj3nRD1QnF7VH","mode":"list","cachedResultName":"WF_ATUALIZA_TOKEN_SGA"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":["base"],"schema":[{"id":"base","displayName":"base","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[176,-48],"id":"9a90f758-1216-48e0-83f4-719f478a9f2a","name":"Execute Workflow","executeOnce":true},{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"30 08 * * *"}]}},"id":"d59ee023-506e-4def-8dd1-7e40bef60f4d","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[-960,128]},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[176,528],"id":"0fb010a3-c4c0-4137-b7d0-1ee46d41f55a","name":"Loop Over Items"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-496,768],"id":"9a5b2bc8-009e-4236-acf8-ff1b6d7a04ba","name":"No Operation, do nothing1"},{"parameters":{},"type":"n8n-nodes-base.noOp","name":"Replace Me","typeVersion":1,"position":[-272,768],"id":"2d435b50-2039-41be-a5e9-876f328e480d"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-944,960],"id":"84f32909-daa1-43a5-8662-45cfdcf58ccc","name":"Aggregate1"},{"parameters":{"tableId":"topAniversariantes","dataToSend":"autoMapInputData"},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-496,528],"id":"eeb3fe0f-7512-4e40-b0a5-02d59d7cb30f","name":"gravaTopAniversariantes","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"S5lx7Z0EUntC6pYv","name":"Cotacao"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"getAll","tableId":"topAniversariantes","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"=data_nascimento","condition":"eq","keyValue":"={{ $now.format('yyyy-MM-dd') }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-48,528],"id":"e4014a09-89c6-401d-9225-1e6f20c02340","name":"buscaTopAniversariantes","credentials":{"supabaseApi":{"id":"S5lx7Z0EUntC6pYv","name":"Cotacao"}}},{"parameters":{"operation":"getAll","tableId":"topaniversariantes_distinct","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"nome_voluntario","condition":"eq","keyValue":"={{ $('Loop Over Items').item.json.nome_voluntario }}"},{"keyName":"msgConsultorEnviada","condition":"eq","keyValue":"false"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-944,768],"id":"3983dd6e-3b53-4438-98fe-baa12b328d1f","name":"buscaRegistrosPorConsultor","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"S5lx7Z0EUntC6pYv","name":"Cotacao"}}},{"parameters":{"mode":"raw","jsonOutput":"={\n    \"mensagem\" : \"{{ $('Replace Me').item.json.nome + ' - ' + $('Replace Me').item.json.telefone_celular + ' - ' + $('Replace Me').item.json.mensagem }}\"\n}","options":{}},"id":"ed709628-0f76-4378-8896-c196c90cadda","name":"agrupaAssociados","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-48,768]},{"parameters":{"language":"python","pythonCode":"# items Ã© a variÃ¡vel padrÃ£o que contÃ©m os dados do nÃ³ anterior\n# Supondo que o nÃ³ anterior tenha um JSON no formato que vocÃª mostrou\n# items[0][\"json\"][\"data\"] Ã© a lista de mensagens\n\ndata = items[0][\"json\"][\"data\"]\n\n# Extrair apenas as mensagens\nmensagens = [item[\"mensagem\"] for item in data]\n\n# Retornar no formato que o n8n espera (uma lista de dicionÃ¡rios)\nreturn [{\"json\": {\"mensagens\": mensagens}}]\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-720,960],"id":"da547390-ac0b-4777-81c4-bb95d11ba720","name":"unificaTextoMensagens","alwaysOutputData":true},{"parameters":{"operation":"delete","tableId":"topAniversariantes","matchType":"allFilters","filters":{"conditions":[{"keyName":"idAniversariante","condition":"gt","keyValue":"0"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[384,512],"id":"483005cb-81e3-4311-8013-2a7002a51360","name":"excluiTopAniversariantes","credentials":{"supabaseApi":{"id":"S5lx7Z0EUntC6pYv","name":"Cotacao"}}},{"parameters":{"operation":"update","tableId":"topAniversariantes","filters":{"conditions":[{"keyName":"nome_voluntario","condition":"eq","keyValue":"={{ $('buscaTopAniversariantes').item.json.nome_voluntario }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"msgConsultorEnviada","fieldValue":"TRUE"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[176,768],"id":"7b4de95f-d0d1-4996-b569-c43eeba50511","name":"Update a row","credentials":{"supabaseApi":{"id":"S5lx7Z0EUntC6pYv","name":"Cotacao"}}},{"parameters":{"resource":"messages-api","instanceName":"zap.top.cor","remoteJid":"=55{{$('buscaTopAniversariantes').item.json.celular_voluntario.match( /\\d+/g ).join('')}}","messageText":"={{ \n'OlÃ¡ ' + $('buscaTopAniversariantes').item.json.nome_voluntario.toLowerCase().replace(/\\b\\w/g, c => c.toUpperCase()) + ', ' +\n'hoje ' + $now.format('dd/MM/yyyy') + ' Ã© aniversÃ¡rio de alguns dos nossos associados na TopBrasil ðŸ¤–' + '.\\n' +\n  'Clique nos links para enviar mensagens para o WhatsApp: \\n\\n' + $('unificaTextoMensagens').item.json.mensagens.join('\\n')\n}}","options_message":{"delay":3000,"linkPreview":false}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-272,960],"id":"8e006b73-e841-4957-a07b-9c6bd4965740","name":"msgDadosAniversariantes1","credentials":{"evolutionApi":{"id":"aemvzOqH8lEJq6Vc","name":"Evolution account"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8c8ca8b5-95d1-4eca-ace4-85f4e68fa167","leftValue":"={{ $('buscaRegistrosPorConsultor').item.json.isEmpty() }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-720,768],"id":"f88aa9f2-b825-42b3-a92a-9ec3a6f04e13","name":"If2"}],"connections":{"When clicking â€˜Execute workflowâ€™":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"No Operation, do nothing":{"main":[[{"node":"buscaToken","type":"main","index":0}]]},"buscaToken":{"main":[[{"node":"buscaSGAAniversariantes","type":"main","index":0}]]},"dadosAniversariantes":{"main":[[{"node":"buscaAssociado","type":"main","index":0}]]},"buscaSGAConsultor":{"main":[[{"node":"reduzURL","type":"main","index":0}]]},"buscaSGAAniversariantes":{"main":[[{"node":"If1","type":"main","index":0}]]},"reduzURL":{"main":[[{"node":"dadosAssociado","type":"main","index":0}]]},"buscaAssociado":{"main":[[{"node":"Split Out1","type":"main","index":0}]]},"dadosAssociado":{"main":[[{"node":"If","type":"main","index":0}]]},"buscaVeiculos":{"main":[[{"node":"buscaSGAConsultor","type":"main","index":0}]]},"Split Out1":{"main":[[{"node":"buscaVeiculos","type":"main","index":0}]]},"Aggregate2":{"main":[[{"node":"buscaTopAniversariantes","type":"main","index":0}]]},"loopAniversariantes":{"main":[[{"node":"dadosAniversariantes","type":"main","index":0}]]},"If":{"main":[[{"node":"gravaTopAniversariantes","type":"main","index":0}]]},"If1":{"main":[[{"node":"Execute Workflow","type":"main","index":0}],[{"node":"loopAniversariantes","type":"main","index":0}]]},"Execute Workflow":{"main":[[{"node":"buscaToken","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"Loop Over Items":{"main":[[{"node":"excluiTopAniversariantes","type":"main","index":0}],[{"node":"buscaRegistrosPorConsultor","type":"main","index":0}]]},"No Operation, do nothing1":{"main":[[{"node":"Replace Me","type":"main","index":0}]]},"Replace Me":{"main":[[{"node":"agrupaAssociados","type":"main","index":0}]]},"Aggregate1":{"main":[[{"node":"unificaTextoMensagens","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"gravaTopAniversariantes":{"main":[[{"node":"Aggregate2","type":"main","index":0}]]},"buscaTopAniversariantes":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"buscaRegistrosPorConsultor":{"main":[[{"node":"If2","type":"main","index":0}]]},"agrupaAssociados":{"main":[[{"node":"Update a row","type":"main","index":0},{"node":"Aggregate1","type":"main","index":0}]]},"unificaTextoMensagens":{"main":[[{"node":"msgDadosAniversariantes1","type":"main","index":0}]]},"excluiTopAniversariantes":{"main":[[]]},"Update a row":{"main":[[]]},"msgDadosAniversariantes1":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"If2":{"main":[[{"node":"Loop Over Items","type":"main","index":0}],[{"node":"No Operation, do nothing1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"8c132e6c-406d-47f6-b0e6-5e469cf8c50b","triggerCount":1,"shared":[{"createdAt":"2025-08-13T13:23:23.775Z","updatedAt":"2025-08-13T13:23:23.775Z","role":"workflow:owner","workflowId":"KCnRnVUKZAdJz3fo","projectId":"Q1ZOyZgW3upjWPqV"}],"tags":[{"createdAt":"2025-09-28T19:46:08.309Z","updatedAt":"2025-09-28T19:46:08.309Z","id":"twNBrzFgyMQjyPj3","name":"EVO ZAP.TOP.COR"}]}