{"createdAt":"2025-12-23T22:25:09.770Z","updatedAt":"2026-01-19T18:21:28.769Z","id":"ad71s94M4UKzKUGY","name":"TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP","active":true,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-1024,-512],"id":"26d1ded2-6184-4b7b-9977-7d1eb9c1d76a","name":"When clicking ‘Execute workflow’"},{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"10 09 * * 1-5"}]}},"id":"77c8afb5-27e5-46de-b75e-edf43760250d","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[-1024,-672]},{"parameters":{"values":{"number":[{"name":"counter"}]},"options":{}},"name":"Init Counter","type":"n8n-nodes-base.set","typeVersion":1,"position":[-144,-592],"id":"50fddb21-271d-4e85-a85b-49753a5eef32"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-800,-592],"id":"97eba1d4-3e80-43e7-937a-928c7946b856","name":"No Operation, do nothing1"},{"parameters":{"operation":"push","list":"boletos","messageData":"={{ JSON.stringify ($json) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1344,-384],"id":"b07f3ef7-0e3b-4fc4-968d-436654e77805","name":"Redis2","credentials":{"redis":{"id":"uLk0Ix9M65LkkOZg","name":"Redis account"}}},{"parameters":{"operation":"push","list":"boletos","messageData":"={{ JSON.stringify ($json) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[928,-592],"id":"987a0fe6-5b68-41ae-b8e3-5fa14a657991","name":"Redis4","credentials":{"redis":{"id":"uLk0Ix9M65LkkOZg","name":"Redis account"}}},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1552,-384],"id":"2aa5145d-af8b-4001-928c-da51d3fc38e5","name":"Aggregate"},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1136,-592],"id":"b85c92d6-af06-4cc9-aac6-ef982a326c39","name":"Aggregate1"},{"parameters":{"resource":"messages-api","instanceName":"evo.top.com","remoteJid":"5531990811559","messageText":"=Resumo do processamento: - {{ $('buscaBoletosTOPCO_D-5').all().length }} registros de inadimplentes na TOP CO para o vencimento em {{ $('dadosPaginaVencD-5').item.json.dtVencimento.toDateTime().format('dd/MM/yyyy') }}. Envio para os consultores concluído com sucesso.","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1968,-592],"id":"7b4d48e9-6378-4ad4-9bdf-99e71205dc60","name":"Enviar texto1","credentials":{"evolutionApi":{"id":"aemvzOqH8lEJq6Vc","name":"Evolution account"}},"onError":"continueRegularOutput"},{"parameters":{"resource":"messages-api","instanceName":"evo.top.com","remoteJid":"5531990811559","messageText":"=Resumo do processamento: - {{ $('buscaBoletos_PVCE_D-2').all().length }} registros de inadimplentes na TOP PV/CE para o vencimento em {{ $('dadosPaginaVencD-2').item.json.dtVencimento.toDateTime().format('dd/MM/yyyy') }}. Envio para os consultores concluído com sucesso.","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2176,-384],"id":"9ba74087-48a5-4f8b-80b4-9c3f99ca2d30","name":"Enviar texto5","credentials":{"evolutionApi":{"id":"aemvzOqH8lEJq6Vc","name":"Evolution account"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"push","list":"boletos","messageData":"={{ JSON.stringify ($json) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1136,-800],"id":"b057fa03-96d1-4cca-9cde-96ead440c054","name":"Redis5","credentials":{"redis":{"id":"uLk0Ix9M65LkkOZg","name":"Redis account"}}},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1344,-800],"id":"10ee726e-d212-4dbe-a8a9-8ed34a962d59","name":"Aggregate2"},{"parameters":{"resource":"messages-api","instanceName":"evo.top.com","remoteJid":"5531990811559","messageText":"=Resumo do processamento: - {{ $('buscaBoletosTOP_PVCECO_D-1').all().length }} registros de inadimplentes na TOP CO para o vencimento em {{ $('dadosPaginaVencD-1').item.json.dtVencimento.toDateTime().format('dd/MM/yyyy') }}. Envio para os consultores concluído com sucesso.","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1968,-800],"id":"c2450f81-83a2-4e81-8ee5-6d63e14bcaf2","name":"Enviar texto","credentials":{"evolutionApi":{"id":"aemvzOqH8lEJq6Vc","name":"Evolution account"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"select *\nfrom topBIBoletos\nwhere data_vencimento = $1\n  and codigo_situacao_boleto = '2'\n  and codigo_regional = '229'\n  and codigo_cooperativa = '39'\n  and situacao_boleto = 'ABERTO'\n  and tipo_boleto in ('FECHAMENTO')  \norder by codigo_voluntario asc","options":{"queryReplacement":"={{ [$('dadosPaginaVencD-5').item.json.dtVencimento ?? null] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[720,-592],"id":"1c9dd39d-8dc9-4ed8-8de2-afdaeb4540d6","name":"buscaBoletosTOPCO_D-5","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"operation":"executeQuery","query":"select *\nfrom topBIBoletos\nwhere data_vencimento = $1\n  and codigo_situacao_boleto = '2'\n  and codigo_regional not in('229')\n  and codigo_cooperativa not in ('39')\n  and situacao_boleto = 'ABERTO'\n  and tipo_boleto in ('FECHAMENTO')  \norder by codigo_voluntario asc","options":{"queryReplacement":"={{ [$('dadosPaginaVencD-2').item.json.dtVencimento ?? null] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[1136,-384],"id":"da101d6d-874d-4a4a-9142-6ec715123355","name":"buscaBoletos_PVCE_D-2","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"operation":"executeQuery","query":"select *\nfrom topBIBoletos\nwhere data_vencimento = $1\n  and codigo_situacao_boleto = '2'\n  and situacao_boleto = 'ABERTO'\n  and tipo_boleto in ('FECHAMENTO')  \norder by codigo_voluntario asc","options":{"queryReplacement":"={{ $('dadosPaginaVencD-1').item.json.dtVencimento }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[928,-800],"id":"0219fed7-7a95-4ffc-96ea-25ed012bbf6e","name":"buscaBoletosTOP_PVCECO_D-1","credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"workflowId":{"__rl":true,"value":"NxXShm6NgPstCPDQ","mode":"list","cachedResultUrl":"/workflow/NxXShm6NgPstCPDQ","cachedResultName":"SUB_TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1760,-384],"name":"Call SUB_TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP","id":"bf1076ea-2ce2-4136-a754-e33c5f53f336"},{"parameters":{"workflowId":{"__rl":true,"value":"NxXShm6NgPstCPDQ","mode":"list","cachedResultUrl":"/workflow/NxXShm6NgPstCPDQ","cachedResultName":"SUB_TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1344,-592],"name":"Call SUB_TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP1","id":"8e97a8bb-bab9-4153-8e00-be8712ac4f70"},{"parameters":{"workflowId":{"__rl":true,"value":"NxXShm6NgPstCPDQ","mode":"list","cachedResultUrl":"/workflow/NxXShm6NgPstCPDQ","cachedResultName":"SUB_TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1552,-800],"name":"Call SUB_TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP2","id":"049768bb-3ac9-4437-992e-17fdff7de766"},{"parameters":{"workflowId":{"__rl":true,"value":"2VuemE7VvQrM65uQ","mode":"list","cachedResultUrl":"/workflow/2VuemE7VvQrM65uQ","cachedResultName":"TMR_POPULA_TOP_BOLETOS"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dataVInicial":"={{\n  (() => {\n    let d = new Date();\n    d.setDate(d.getDate() - 5); // começa 5 dia após o vencimento\n\n    // enquanto for segunda (1), retrocede + 9 dias\n    while (d.getDay() === 1) {\n      d.setDate(d.getDate() - 8);\n    }\n\n    // formata para dd/MM/yyyy\n    const dd = String(d.getDate()).padStart(2, '0');\n    const mm = String(d.getMonth() + 1).padStart(2, '0');\n    const yyyy = d.getFullYear();\n\n    return `${dd}/${mm}/${yyyy}`;\n  })()\n}}"},"matchingColumns":["origem"],"schema":[{"id":"dataVInicial","displayName":"dataVInicial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-576,-592],"id":"ee3c9378-005b-4aff-9291-1c07228e634c","name":"AtualizaBoletos"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eca47edb-494d-4817-a8de-f54d74458b2f","leftValue":"={{ $('verificaFeriado').item.json.isHoliday }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"595ec626-cc98-48c8-ad11-31862b70a619","leftValue":"={{ $json.holiday.type }}","rightValue":"facultativo","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[928,-384],"id":"8039270f-1bac-44f3-b4d3-2cd717f4bf61","name":"If"},{"parameters":{"workflowId":{"__rl":true,"value":"QV6HWDmqkiXXdyFk","mode":"list","cachedResultUrl":"/workflow/QV6HWDmqkiXXdyFk","cachedResultName":"SUB_VERIFICA_FERIADO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data":"={{ $('dadosPaginaVencD-2').item.json.dtVencimento }}"},"matchingColumns":[],"schema":[{"id":"data","displayName":"data","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[720,-384],"id":"e9d71890-3241-425a-beee-d530f4c8370f","name":"verificaFeriado"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eca47edb-494d-4817-a8de-f54d74458b2f","leftValue":"={{ $('verificaFeriado2').item.json.isHoliday }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"642007da-5bd5-4201-8f49-1faee96f7b9f","leftValue":"={{ $json.holiday.type }}","rightValue":"facultativo","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[720,-800],"id":"77e4b79e-c6a7-4934-bc8f-49ae320fbe3d","name":"If2"},{"parameters":{"workflowId":{"__rl":true,"value":"QV6HWDmqkiXXdyFk","mode":"list","cachedResultUrl":"/workflow/QV6HWDmqkiXXdyFk","cachedResultName":"SUB_VERIFICA_FERIADO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"data":"={{ $('dadosPaginaVencD-1').item.json.dtVencimento }}"},"matchingColumns":[],"schema":[{"id":"data","displayName":"data","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[512,-800],"id":"a684f63b-4325-46c5-a455-bec47c79b3a1","name":"verificaFeriado2"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[288,-976],"id":"4141add5-555f-43bd-871c-c1bda1861779","name":"Aggregate3"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-352,-592],"id":"138d09f7-e17e-4aba-b922-3f782e283e40","name":"Aggregate4"},{"parameters":{"assignments":{"assignments":[{"id":"4f98bfdb-bf33-4568-93cd-17caa7af1eac","name":"quantidadePagina","value":3000,"type":"number"},{"id":"7da3ae77-c98b-4e88-acc2-764b9430c6bc","name":"pagina","value":"=0","type":"number"},{"id":"a5ba2546-bb0c-4057-ae8e-27c8d8df705e","name":"dtVencimento","value":"={{ $json.data_vencimento?.toDateTime()?.format('yyyy/MM/dd') || null }}","type":"string"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[512,-384],"id":"8fec1368-fabb-4353-b90b-b7f14fd9319a","name":"dadosPaginaVencD-2"},{"parameters":{"assignments":{"assignments":[{"id":"4f98bfdb-bf33-4568-93cd-17caa7af1eac","name":"quantidadePagina","value":3000,"type":"number"},{"id":"7da3ae77-c98b-4e88-acc2-764b9430c6bc","name":"pagina","value":"=0","type":"number"},{"id":"a5ba2546-bb0c-4057-ae8e-27c8d8df705e","name":"dtVencimento","value":"={{ $json.data_vencimento?.toDateTime()?.format('yyyy/MM/dd') || null }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[512,-592],"id":"a9427c49-821a-4d78-a324-c8ae9bf03f20","name":"dadosPaginaVencD-5"},{"parameters":{"assignments":{"assignments":[{"id":"4f98bfdb-bf33-4568-93cd-17caa7af1eac","name":"quantidadePagina","value":3000,"type":"number"},{"id":"7da3ae77-c98b-4e88-acc2-764b9430c6bc","name":"pagina","value":"=0","type":"number"},{"id":"a5ba2546-bb0c-4057-ae8e-27c8d8df705e","name":"dtVencimento","value":"={{\n  (() => {\n    let d = new Date();\n    d.setDate(d.getDate() - 1); // começa 5 dia após o vencimento\n\n    // enquanto for segunda (1), retrocede + 9 dias\n    while (d.getDay() === 0) {\n      d.setDate(d.getDate() - 2);\n    }\n\n    // formata para dd/MM/yyyy\n    const dd = String(d.getDate()).padStart(2, '0');\n    const mm = String(d.getMonth() + 1).padStart(2, '0');\n    const yyyy = d.getFullYear();\n\n    return `${yyyy}/${mm}/${dd}`;\n  })()\n}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[288,-800],"id":"8ffa722f-4587-4769-931b-e2ba631b48c7","name":"dadosPaginaVencD-1"},{"parameters":{"workflowId":{"__rl":true,"value":"XCl9Lga8P5AQpTAb","mode":"list","cachedResultUrl":"/workflow/XCl9Lga8P5AQpTAb","cachedResultName":"WH_LIMPA_MEMORIA_CHAT"},"workflowInputs":{"mappingMode":"defineBelow","value":{}},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[512,-976],"id":"4388428e-07b7-41ee-85cb-70d0c818cf19","name":"limpaMemoria"},{"parameters":{"workflowId":{"__rl":true,"value":"XCl9Lga8P5AQpTAb","mode":"list","cachedResultUrl":"/workflow/XCl9Lga8P5AQpTAb","cachedResultName":"WH_LIMPA_MEMORIA_CHAT"},"workflowInputs":{"mappingMode":"defineBelow","value":{}},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[2400,-592],"id":"def18a3d-c5bc-42a9-99f3-b885aafdb8f7","name":"limpaMemoria1"},{"parameters":{"operation":"executeQuery","query":"WITH vencimentos AS (\n    SELECT unnest(ARRAY[5,10,15,20,25,26,30]) AS dia_vencimento\n),\nbase AS (\n    SELECT\n        dia_vencimento,\n        make_date(\n            EXTRACT(YEAR FROM CURRENT_DATE)::int,\n            EXTRACT(MONTH FROM CURRENT_DATE)::int,\n            dia_vencimento\n        ) AS data_vencimento_original\n    FROM vencimentos\n),\ncalculado AS (\n    SELECT\n        b.dia_vencimento,\n        b.data_vencimento_original,\n        CASE\n            WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                THEN b.data_vencimento_original + INTERVAL '2 days'\n            WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                THEN b.data_vencimento_original + INTERVAL '1 day'\n            ELSE b.data_vencimento_original\n        END::date AS data_base_ajustada,\n        (\n            CASE\n                WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                    THEN b.data_vencimento_original + INTERVAL '2 days'\n                WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                    THEN b.data_vencimento_original + INTERVAL '1 day'\n                ELSE b.data_vencimento_original\n            END\n            + INTERVAL '4 days'\n        )::date AS data_5_dias_corridos,\n        (\n            SELECT d::date\n            FROM generate_series(\n                (\n                    CASE\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                            THEN b.data_vencimento_original + INTERVAL '2 days'\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                            THEN b.data_vencimento_original + INTERVAL '1 day'\n                        ELSE b.data_vencimento_original\n                    END\n                ) + INTERVAL '1 day',\n                (\n                    CASE\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                            THEN b.data_vencimento_original + INTERVAL '2 days'\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                            THEN b.data_vencimento_original + INTERVAL '1 day'\n                        ELSE b.data_vencimento_original\n                    END\n                ) + INTERVAL '10 days',\n                INTERVAL '1 day'\n            ) AS d\n            WHERE EXTRACT(DOW FROM d) NOT IN (0,6)\n            ORDER BY d\n            OFFSET 1\n            LIMIT 1\n        ) AS data_2_dias_uteis\n    FROM base b\n),\nresultado AS (\n    SELECT\n        dia_vencimento,\n        data_vencimento_original::date AS data_vencimento,\n        data_5_dias_corridos,\n        data_2_dias_uteis\n    FROM calculado\n    WHERE data_5_dias_corridos = CURRENT_DATE)\nSELECT *\nFROM resultado\nUNION ALL\nSELECT\n    NULL::int  AS dia_vencimento,\n    NULL::date AS data_vencimento,\n    NULL::date AS data_5_dias_corridos,\n    NULL::date AS data_2_dias_uteis\nWHERE NOT EXISTS (SELECT 1 FROM resultado);\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[80,-592],"id":"58bde23d-8fd3-4201-bf8a-cc657cf719d7","name":"buscaBoletosTOP_CO_D-5_SMS1","alwaysOutputData":true,"credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"operation":"executeQuery","query":"WITH vencimentos AS (\n    SELECT unnest(ARRAY[5,10,15,20,25,26,30]) AS dia_vencimento\n),\nbase AS (\n    SELECT\n        dia_vencimento,\n        make_date(\n            EXTRACT(YEAR FROM CURRENT_DATE)::int,\n            EXTRACT(MONTH FROM CURRENT_DATE)::int,\n            dia_vencimento\n        ) AS data_vencimento_original\n    FROM vencimentos\n),\ncalculado AS (\n    SELECT\n        b.dia_vencimento,\n        b.data_vencimento_original,\n        CASE\n            WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                THEN b.data_vencimento_original + INTERVAL '2 days'\n            WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                THEN b.data_vencimento_original + INTERVAL '1 day'\n            ELSE b.data_vencimento_original\n        END::date AS data_base_ajustada,\n        (\n            CASE\n                WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                    THEN b.data_vencimento_original + INTERVAL '2 days'\n                WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                    THEN b.data_vencimento_original + INTERVAL '1 day'\n                ELSE b.data_vencimento_original\n            END\n            + INTERVAL '4 days'\n        )::date AS data_5_dias_corridos,\n        (\n            SELECT d::date\n            FROM generate_series(\n                (\n                    CASE\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                            THEN b.data_vencimento_original + INTERVAL '2 days'\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                            THEN b.data_vencimento_original + INTERVAL '1 day'\n                        ELSE b.data_vencimento_original\n                    END\n                ) + INTERVAL '1 day',\n                (\n                    CASE\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 6\n                            THEN b.data_vencimento_original + INTERVAL '2 days'\n                        WHEN EXTRACT(DOW FROM b.data_vencimento_original) = 0\n                            THEN b.data_vencimento_original + INTERVAL '1 day'\n                        ELSE b.data_vencimento_original\n                    END\n                ) + INTERVAL '10 days',\n                INTERVAL '1 day'\n            ) AS d\n            WHERE EXTRACT(DOW FROM d) NOT IN (0,6)\n            ORDER BY d\n            OFFSET 1\n            LIMIT 1\n        ) AS data_2_dias_uteis\n    FROM base b\n),\nresultado AS (\n    SELECT\n        dia_vencimento,\n        data_vencimento_original::date AS data_vencimento,\n        data_5_dias_corridos,\n        data_2_dias_uteis\n    FROM calculado\n    WHERE data_2_dias_uteis = CURRENT_DATE)\nSELECT *\nFROM resultado\nUNION ALL\nSELECT\n    NULL::int  AS dia_vencimento,\n    NULL::date AS data_vencimento,\n    NULL::date AS data_5_dias_corridos,\n    NULL::date AS data_2_dias_uteis\nWHERE NOT EXISTS (SELECT 1 FROM resultado);\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[80,-384],"id":"64de9f5e-814b-4497-943e-1d40ded81360","name":"buscaBoletosTOP_2D_UTEIS","alwaysOutputData":true,"credentials":{"postgres":{"id":"Ph2RnhkaunVC4Tqh","name":"postgresBD_ERP_TOP"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b40f6db2-e195-4b81-9a38-4e9205aec686","leftValue":"={{ $json.data_2_dias_uteis?.toDateTime()?.format('yyyy-MM-dd') || null}}","rightValue":"={{ $now.format('yyyy-MM-dd') }}","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[288,-384],"id":"b2dc608b-4414-4270-9a38-b3b83d92f4a3","name":"If3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b40f6db2-e195-4b81-9a38-4e9205aec686","leftValue":"={{ $json.data_5_dias_corridos?.toDateTime()?.format('yyyy-MM-dd') }}","rightValue":"={{ $now.format('yyyy-MM-dd') }}","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[288,-592],"id":"67812595-8ef5-46dc-ad6d-ec584156731e","name":"If4"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1760,-800],"id":"dd03b763-31f4-4142-a0ad-38b01e8d2ae9","name":"Aggregate5"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1760,-592],"id":"b1c68427-0ea6-4b6d-9e79-f2a9541aa9ab","name":"Aggregate6"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1968,-384],"id":"63416120-130f-40da-be58-b293366c80af","name":"Aggregate7"}],"connections":{"When clicking ‘Execute workflow’":{"main":[[{"node":"No Operation, do nothing1","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"No Operation, do nothing1","type":"main","index":0}]]},"Init Counter":{"main":[[{"node":"Aggregate3","type":"main","index":0},{"node":"dadosPaginaVencD-1","type":"main","index":0},{"node":"buscaBoletosTOP_2D_UTEIS","type":"main","index":0},{"node":"buscaBoletosTOP_CO_D-5_SMS1","type":"main","index":0}]]},"No Operation, do nothing1":{"main":[[{"node":"AtualizaBoletos","type":"main","index":0}]]},"Redis2":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"Redis4":{"main":[[{"node":"Aggregate1","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Call SUB_TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP","type":"main","index":0}]]},"Aggregate1":{"main":[[{"node":"Call SUB_TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP1","type":"main","index":0}]]},"Enviar texto1":{"main":[[{"node":"limpaMemoria1","type":"main","index":0}]]},"Enviar texto5":{"main":[[{"node":"limpaMemoria1","type":"main","index":0}]]},"Redis5":{"main":[[{"node":"Aggregate2","type":"main","index":0}]]},"Aggregate2":{"main":[[{"node":"Call SUB_TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP2","type":"main","index":0}]]},"Enviar texto":{"main":[[{"node":"limpaMemoria1","type":"main","index":0}]]},"buscaBoletosTOPCO_D-5":{"main":[[{"node":"Redis4","type":"main","index":0}]]},"buscaBoletos_PVCE_D-2":{"main":[[{"node":"Redis2","type":"main","index":0}]]},"buscaBoletosTOP_PVCECO_D-1":{"main":[[{"node":"Redis5","type":"main","index":0}]]},"Call SUB_TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP":{"main":[[{"node":"Aggregate7","type":"main","index":0}]]},"Call SUB_TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP1":{"main":[[{"node":"Aggregate6","type":"main","index":0}]]},"Call SUB_TMR_MSG_INADIMPLENTES_CONSULTORES_BD_ERP2":{"main":[[{"node":"Aggregate5","type":"main","index":0}]]},"AtualizaBoletos":{"main":[[{"node":"Aggregate4","type":"main","index":0}]]},"If":{"main":[[{"node":"buscaBoletos_PVCE_D-2","type":"main","index":0}]]},"verificaFeriado":{"main":[[{"node":"If","type":"main","index":0}]]},"If2":{"main":[[{"node":"buscaBoletosTOP_PVCECO_D-1","type":"main","index":0}]]},"verificaFeriado2":{"main":[[{"node":"If2","type":"main","index":0}]]},"Aggregate3":{"main":[[{"node":"limpaMemoria","type":"main","index":0}]]},"Aggregate4":{"main":[[{"node":"Init Counter","type":"main","index":0}]]},"dadosPaginaVencD-2":{"main":[[{"node":"verificaFeriado","type":"main","index":0}]]},"dadosPaginaVencD-5":{"main":[[{"node":"buscaBoletosTOPCO_D-5","type":"main","index":0}]]},"dadosPaginaVencD-1":{"main":[[{"node":"verificaFeriado2","type":"main","index":0}]]},"buscaBoletosTOP_CO_D-5_SMS1":{"main":[[{"node":"If4","type":"main","index":0}]]},"buscaBoletosTOP_2D_UTEIS":{"main":[[{"node":"If3","type":"main","index":0}]]},"If3":{"main":[[{"node":"dadosPaginaVencD-2","type":"main","index":0}]]},"If4":{"main":[[{"node":"dadosPaginaVencD-5","type":"main","index":0}]]},"Aggregate5":{"main":[[{"node":"Enviar texto","type":"main","index":0}]]},"Aggregate6":{"main":[[{"node":"Enviar texto1","type":"main","index":0}]]},"Aggregate7":{"main":[[{"node":"Enviar texto5","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveDataErrorExecution":"all","saveDataSuccessExecution":"all","saveExecutionProgress":true,"saveManualExecutions":true,"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"TfwD6eX8vHLcjYJt","timeSavedPerExecution":2},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"8f36062f-3b85-4b7a-898e-f326bce9669c","triggerCount":1,"shared":[{"createdAt":"2025-12-23T22:25:09.770Z","updatedAt":"2025-12-23T22:25:09.770Z","role":"workflow:owner","workflowId":"ad71s94M4UKzKUGY","projectId":"Q1ZOyZgW3upjWPqV"}],"tags":[{"createdAt":"2025-11-27T19:20:14.981Z","updatedAt":"2025-11-27T19:20:14.981Z","id":"G1PiCFR214hWj5Im","name":"BDERP"}]}